name: Configure AWS-GitHub Integration

on:
  workflow_dispatch:
    inputs:
      aws_account_id:
        description: 'AWS Account ID'
        required: true
        type: string
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'eu-central-1'
        type: string
      dev_s3_bucket:
        description: 'Development S3 Bucket Name (must exist)'
        required: true
        type: string
      prod_s3_bucket:
        description: 'Production S3 Bucket Name (must exist)'
        required: true
        type: string
      github_repository:
        description: 'GitHub Repository (owner/repo)'
        required: true
        default: 'Octonius/octonius-platform'
        type: string
      dev_cloudfront_id:
        description: 'Development CloudFront Distribution ID'
        required: true
        type: string
      prod_cloudfront_id:
        description: 'Production CloudFront Distribution ID'
        required: true
        type: string

env:
  AWS_REGION: ${{ inputs.aws_region }}
  AWS_ACCOUNT_ID: ${{ inputs.aws_account_id }}
  AWS_ROLE_NAME: github-actions-role
  GITHUB_REPOSITORY: ${{ inputs.github_repository }}

permissions:
  id-token: write
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check and Create OIDC provider
        run: |
          PROVIDER_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
          
          if aws iam get-open-id-connect-provider --open-id-connect-provider-arn "$PROVIDER_ARN" >/dev/null 2>&1; then
            echo "OIDC provider already exists"
          else
            echo "Creating OIDC provider..."
            aws iam create-open-id-connect-provider \
              --url https://token.actions.githubusercontent.com \
              --client-id-list sts.amazonaws.com
          fi

      - name: Create trust policy
        run: |
          echo "Creating trust policy with:"
          echo "  AWS_ACCOUNT_ID: ${AWS_ACCOUNT_ID}"
          echo "  GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          
          cat > trust-policy.json << EOF
          {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
                      },
                      "Action": "sts:AssumeRoleWithWebIdentity",
                      "Condition": {
                          "StringLike": {
                              "token.actions.githubusercontent.com:sub": "repo:${GITHUB_REPOSITORY}:*"
                          },
                          "StringEquals": {
                              "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                          }
                      }
                  }
              ]
          }
          EOF
          echo "Trust policy content:"
          cat trust-policy.json

      - name: Check and Create IAM role
        run: |
          if aws iam get-role --role-name ${AWS_ROLE_NAME} >/dev/null 2>&1; then
            echo "IAM role ${AWS_ROLE_NAME} already exists"
            echo "Updating trust policy..."
            aws iam update-assume-role-policy \
              --role-name ${AWS_ROLE_NAME} \
              --policy-document file://trust-policy.json
          else
            echo "Creating IAM role ${AWS_ROLE_NAME}..."
            aws iam create-role \
              --role-name ${AWS_ROLE_NAME} \
              --assume-role-policy-document file://trust-policy.json
          fi

      - name: Check and Update IAM role policy
        env:
          DEV_S3_BUCKET: ${{ inputs.dev_s3_bucket }}
          PROD_S3_BUCKET: ${{ inputs.prod_s3_bucket }}
          DEV_CLOUDFRONT_ID: ${{ inputs.dev_cloudfront_id }}
          PROD_CLOUDFRONT_ID: ${{ inputs.prod_cloudfront_id }}
        run: |
          echo "Creating role policy with:"
          echo "  AWS_ACCOUNT_ID: ${AWS_ACCOUNT_ID}"
          echo "  AWS_REGION: ${AWS_REGION}"
          echo "  DEV_S3_BUCKET: ${DEV_S3_BUCKET}"
          echo "  PROD_S3_BUCKET: ${PROD_S3_BUCKET}"
          echo "  DEV_CLOUDFRONT_ID: ${DEV_CLOUDFRONT_ID}"
          echo "  PROD_CLOUDFRONT_ID: ${PROD_CLOUDFRONT_ID}"
          
          cat > role-policy.json << EOF
          {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Action": [
                          "iam:GetRole",
                          "iam:CreatePolicy",
                          "iam:CreatePolicyVersion",
                          "iam:CreateRole",
                          "iam:UpdateAssumeRolePolicy",
                          "iam:PutRolePolicy",
                          "iam:GetOpenIDConnectProvider",
                          "iam:CreateOpenIDConnectProvider"
                      ],
                      "Resource": [
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:role/github-actions-role",
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Action": [
                          "iam:CreatePolicy",
                          "iam:GetPolicy",
                          "iam:CreatePolicyVersion",
                          "iam:SetDefaultPolicyVersion",
                          "iam:DeletePolicy",
                          "iam:DeletePolicyVersion",
                          "iam:ListPolicyVersions"
                      ],
                      "Resource": [
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:policy/dev-cdk-deploy-policy",
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:policy/prod-cdk-deploy-policy"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Action": [
                          "s3:PutObject",
                          "s3:GetObject",
                          "s3:ListBucket",
                          "s3:DeleteObject"
                      ],
                      "Resource": [
                          "arn:aws:s3:::${DEV_S3_BUCKET}",
                          "arn:aws:s3:::${DEV_S3_BUCKET}/*",
                          "arn:aws:s3:::${PROD_S3_BUCKET}",
                          "arn:aws:s3:::${PROD_S3_BUCKET}/*"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Action": "cloudfront:CreateInvalidation",
                      "Resource": [
                          "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${DEV_CLOUDFRONT_ID}",
                          "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${PROD_CLOUDFRONT_ID}"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Action": [
                          "sts:AssumeRole",
                          "iam:PassRole"
                      ],
                      "Resource": [
                        "arn:aws:iam::${AWS_ACCOUNT_ID}:role/cdk-*"
                      ]
                  },
                  {
                      "Sid": "CloudFormationPermissions",
                      "Effect": "Allow",
                      "Action": [
                          "cloudformation:CreateStack",
                          "cloudformation:UpdateStack",
                          "cloudformation:DeleteStack",
                          "cloudformation:DescribeStacks",
                          "cloudformation:DescribeStackEvents",
                          "cloudformation:DescribeStackResources",
                          "cloudformation:GetTemplate",
                          "cloudformation:ValidateTemplate",
                          "cloudformation:CreateChangeSet",
                          "cloudformation:DescribeChangeSet",
                          "cloudformation:ExecuteChangeSet",
                          "cloudformation:DeleteChangeSet",
                          "cloudformation:ListStackResources",
                          "cloudformation:DescribeStackDriftDetectionStatus",
                          "cloudformation:DetectStackDrift",
                          "cloudformation:DescribeStackResourceDrifts",
                          "cloudformation:GetTemplateSummary",
                          "cloudformation:ListExports",
                          "cloudformation:ListImports",
                          "cloudformation:DescribeStackInstance",
                          "cloudformation:ListStacks",
                          "cloudformation:SetStackPolicy",
                          "cloudformation:GetStackPolicy",
                          "cloudformation:ListChangeSets",
                          "cloudformation:GetTemplateSummary",
                          "cloudformation:ListStackResources",
                          "cloudformation:ListStacks",
                          "cloudformation:UpdateTerminationProtection",
                          "cloudformation:GetTemplateSummary",
                          "cloudformation:ListStackResources",
                          "cloudformation:ListStacks",
                          "cloudformation:UpdateTerminationProtection"
                      ],
                      "Resource": [
                          "arn:aws:cloudformation:${AWS_REGION}:${AWS_ACCOUNT_ID}:stack/CDKToolkit/*",
                          "arn:aws:cloudformation:${AWS_REGION}:${AWS_ACCOUNT_ID}:stack/*/*"
                      ]
                  },
                  {
                      "Sid": "CDKContextLookupPermissions",
                      "Effect": "Allow",
                      "Action": [
                          "ec2:DescribeAvailabilityZones",
                          "ec2:DescribeVpcs",
                          "ec2:DescribeSubnets",
                          "ec2:DescribeRouteTables",
                          "ec2:DescribeSecurityGroups",
                          "route53:ListHostedZones",
                          "route53:ListHostedZonesByName",
                          "route53:GetHostedZone",
                          "ssm:GetParameter",
                          "ec2:DescribeRegions",
                          "ec2:DescribeAccountAttributes",
                          "ec2:DescribeImages",
                          "ec2:DescribeInstanceTypes",
                          "ec2:DescribeKeyPairs",
                          "ec2:DescribeSecurityGroups",
                          "ec2:DescribeVpcs",
                          "ec2:DescribeSubnets",
                          "ec2:DescribeAvailabilityZones",
                          "ec2:DescribeRouteTables",
                          "ec2:DescribeNetworkAcls",
                          "ec2:DescribeNetworkInterfaces",
                          "ec2:DescribeTags",
                          "ec2:DescribeVolumes",
                          "ec2:DescribeSnapshots",
                          "ec2:DescribeInstances",
                          "ec2:DescribeAddresses",
                          "ec2:DescribeNatGateways",
                          "ec2:DescribeInternetGateways",
                          "ec2:DescribeVpcEndpoints",
                          "ec2:DescribeVpcEndpointServices",
                          "ec2:DescribeVpcPeeringConnections",
                          "ec2:DescribeVpcAttribute",
                          "ec2:DescribeSubnetAttribute",
                          "ec2:DescribeNetworkInterfaceAttribute",
                          "ec2:DescribeVolumeAttribute",
                          "ec2:DescribeSnapshotAttribute",
                          "ec2:DescribeInstanceAttribute",
                          "ec2:DescribeAddressesAttribute",
                          "ec2:DescribeNatGatewayAttribute",
                          "ec2:DescribeInternetGatewayAttribute",
                          "ec2:DescribeVpcEndpointAttribute",
                          "ec2:DescribeVpcEndpointServiceAttribute",
                          "ec2:DescribeVpcPeeringConnectionAttribute"
                      ],
                      "Resource": "*"
                  },
                  {
                      "Sid": "S3CDKToolkitBucketPermissions",
                      "Effect": "Allow",
                      "Action": [
                          "s3:CreateBucket",
                          "s3:GetBucketLocation",
                          "s3:GetBucketVersioning",
                          "s3:PutBucketVersioning",
                          "s3:GetEncryptionConfiguration",
                          "s3:PutEncryptionConfiguration",
                          "s3:GetBucketPublicAccessBlock",
                          "s3:PutBucketPublicAccessBlock",
                          "s3:PutBucketPolicy",
                          "s3:GetBucketPolicy",
                          "s3:PutLifecycleConfiguration",
                          "s3:PutBucketTagging",
                          "s3:GetBucketTagging",
                          "s3:PutObject",
                          "s3:GetObject",
                          "s3:ListBucket",
                          "s3:DeleteObject",
                          "s3:DeleteBucket"
                      ],
                      "Resource": [
                          "arn:aws:s3:::cdk-*"
                      ]
                  },
                  {
                      "Sid": "SSMCDKBootstrapParameters",
                      "Effect": "Allow", 
                      "Action": [
                          "ssm:GetParameter",
                          "ssm:PutParameter",
                          "ssm:DeleteParameter",
                          "ssm:GetParameters",
                          "ssm:GetParametersByPath",
                          "ssm:DescribeParameters"
                      ],
                      "Resource": [
                          "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/cdk-bootstrap/*",
                          "arn:aws:ssm:${AWS_REGION}:${AWS_ACCOUNT_ID}:parameter/cdk/*"
                      ]
                  },
                  {
                      "Sid": "ECRCDKBootstrapPermissions",
                      "Effect": "Allow",
                      "Action": [
                          "ecr:CreateRepository",
                          "ecr:DescribeRepositories",
                          "ecr:PutLifecyclePolicy",
                          "ecr:SetRepositoryPolicy",
                          "ecr:DeleteRepository"
                      ],
                      "Resource": [
                          "arn:aws:ecr:${AWS_REGION}:${AWS_ACCOUNT_ID}:repository/cdk-*"
                      ]
                  },
                  {
                      "Sid": "IAMCDKBootstrapRoleCreation",
                      "Effect": "Allow",
                      "Action": [
                          "iam:CreateRole",
                          "iam:AttachRolePolicy",
                          "iam:PutRolePolicy",
                          "iam:GetRole",
                          "iam:TagRole",
                          "iam:UpdateRole",
                          "iam:DeleteRole",
                          "iam:DetachRolePolicy",
                          "iam:DeleteRolePolicy",
                          "iam:UpdateAssumeRolePolicy"
                      ],
                      "Resource": [
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:role/cdk-*"
                      ]
                  },
                  {
                      "Sid": "KMSCDKBootstrapPermissions",
                      "Effect": "Allow",
                      "Action": [
                          "kms:CreateKey",
                          "kms:CreateAlias",
                          "kms:DescribeKey",
                          "kms:PutKeyPolicy",
                          "kms:TagResource",
                          "kms:UntagResource",
                          "kms:ScheduleKeyDeletion",
                          "kms:CreateGrant",
                          "kms:DescribeKeyPolicy"
                      ],
                      "Resource": "*",
                      "Condition": {
                          "StringLike": {
                              "kms:AliasName": "alias/cdk-*"
                          }
                      }
                  }
              ]
          }
          EOF

          echo "Role policy content (first 50 lines):"
          head -n 50 role-policy.json

          # Always update the policy to ensure it's current
          aws iam put-role-policy \
            --role-name ${AWS_ROLE_NAME} \
            --policy-name github-actions-policy \
            --policy-document file://role-policy.json

      - name: Generate GitHub App Token
        uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Authenticate GitHub CLI
        run: |
          # Configure GitHub CLI to use the token
          echo "${{ steps.generate-token.outputs.token }}" | gh auth login --with-token

      - name: Set GitHub Secrets
        id: setup-complete
        run: |
          # Function to set secret with error handling
          set_secret() {
            local name=$1
            local value=$2
            if ! gh secret set "$name" --body "$value" --repo "${GITHUB_REPOSITORY}"; then
              echo "Failed to set secret: $name"
              exit 1
            fi
            echo "Successfully set secret: $name"
          }
          
          # Set common AWS account secrets
          set_secret "AWS_ACCOUNT_ID" "${AWS_ACCOUNT_ID}"
          set_secret "AWS_ROLE_NAME" "${AWS_ROLE_NAME}"
          set_secret "AWS_REGION" "${AWS_REGION}"
          set_secret "REPO_NAME" "${GITHUB_REPOSITORY}"
          
          # Set environment-specific bucket names
          set_secret "DEV_S3_BUCKET" "${{ inputs.dev_s3_bucket }}"
          set_secret "PROD_S3_BUCKET" "${{ inputs.prod_s3_bucket }}"
          
          # Set CloudFront IDs
          set_secret "DEV_CLOUDFRONT_ID" "${{ inputs.dev_cloudfront_id }}"
          set_secret "PROD_CLOUDFRONT_ID" "${{ inputs.prod_cloudfront_id }}"