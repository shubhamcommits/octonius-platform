name: Provision AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_ROLE_NAME:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      DEV_S3_BUCKET:
        required: true
      PROD_S3_BUCKET:
        required: true
      DEV_CLOUDFRONT_ID:
        required: true
      PROD_CLOUDFRONT_ID:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_NAME: ${{ secrets.AWS_ROLE_NAME }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NODE_ENV: ${{ inputs.environment }}
      APP_NAME: 'octonius'
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME || 'dev.octonius.com' }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install CDK
        run: |
          npm install -g aws-cdk

      - name: Preprocess policy files
        run: |
          for policy_file in cdk/*-policy.json; do
            sed -i "s/\${AWS_ACCOUNT_ID}/${{ env.AWS_ACCOUNT_ID }}/g" "$policy_file"
            sed -i "s/\${AWS_REGION}/${{ env.AWS_REGION }}/g" "$policy_file"
            sed -i "s/\${DEV_S3_BUCKET}/${{ secrets.DEV_S3_BUCKET }}/g" "$policy_file"
            sed -i "s/\${PROD_S3_BUCKET}/${{ secrets.PROD_S3_BUCKET }}/g" "$policy_file"
          done

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build
        run: npm run build

      - name: Create/Update IAM Policy for CDK CloudFormation Execution
        run: |
          create_or_update_policy() {
            local policy_name=$1
            local policy_file=$2
            local description=$3
            local account_id="${{ env.AWS_ACCOUNT_ID }}"
            local expected_policy_arn="arn:aws:iam::${account_id}:policy/${policy_name}"

            if aws iam get-policy --policy-arn ${expected_policy_arn} > /dev/null 2>&1; then
              POLICY_VERSIONS_JSON=$(aws iam list-policy-versions --policy-arn "${expected_policy_arn}")
              VERSION_COUNT=$(echo "${POLICY_VERSIONS_JSON}" | jq '.Versions | length')

              if [ "${VERSION_COUNT}" -ge 5 ]; then
                OLDEST_NON_DEFAULT_VERSION_ID=$(echo "${POLICY_VERSIONS_JSON}" | \
                  jq -r '.Versions | sort_by(.CreateDate) | map(select(.IsDefaultVersion == false)) | .[0].VersionId // null')

                if [ -n "${OLDEST_NON_DEFAULT_VERSION_ID}" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "null" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "" ]; then
                  aws iam delete-policy-version --policy-arn "${expected_policy_arn}" --version-id "${OLDEST_NON_DEFAULT_VERSION_ID}"
                fi
              fi

              aws iam create-policy-version --policy-arn "${expected_policy_arn}" --policy-document file://${policy_file} --set-as-default
            else
              aws iam create-policy --policy-name ${policy_name} --policy-document file://${policy_file} --description "${description}"
            fi
          }

          create_or_update_policy "${{ inputs.environment }}-cdk-base-policy" "cdk/cdk-base-policy.json" "Base policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-cloudformation-policy" "cdk/cdk-cloudformation-policy.json" "CloudFormation policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-s3-policy" "cdk/cdk-s3-policy.json" "S3 policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-iam-policy" "cdk/cdk-iam-policy.json" "IAM policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-services-policy" "cdk/cdk-services-policy.json" "Services policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-network-policy" "cdk/cdk-network-policy.json" "Network policy for CDK operations"

          echo "AWS_CDK_POLICY_ARN_FROM_FILE=${{ inputs.environment }}-cdk-base-policy_ARN,${{ inputs.environment }}-cdk-cloudformation-policy_ARN,${{ inputs.environment }}-cdk-s3-policy_ARN,${{ inputs.environment }}-cdk-iam-policy_ARN,${{ inputs.environment }}-cdk-services-policy_ARN,${{ inputs.environment }}-cdk-network-policy_ARN" >> $GITHUB_ENV
        shell: bash

      - name: Bootstrap CDK
        run: |
          if aws cloudformation describe-stacks --stack-name CDKToolkit > /dev/null 2>&1; then
            BOOTSTRAP_VERSION=$(aws ssm get-parameter --name "/cdk-bootstrap/${{ inputs.environment }}/version" --query "Parameter.Value" --output text 2>/dev/null || echo "0")
            if [ "$BOOTSTRAP_VERSION" != "2" ]; then
              cdk bootstrap --cloudformation-execution-policies ${{ env.AWS_CDK_POLICY_ARN_FROM_FILE }} --verbose
            fi
          else
            cdk bootstrap --cloudformation-execution-policies ${{ env.AWS_CDK_POLICY_ARN_FROM_FILE }} --verbose
          fi

          aws ssm put-parameter \
            --name "/cdk-bootstrap/${{ inputs.environment }}/version" \
            --value "2" \
            --type String \
            --overwrite || true

      - name: CDK Deploy
        env:
          NODE_ENV: ${{ inputs.environment }}
        run: |
          if [ "$NODE_ENV" = "prod" ]; then
            cdk deploy --all --require-approval never --parameters env=prod
          elif [ "$NODE_ENV" = "dev" ]; then
            cdk deploy --all --require-approval never --parameters env=dev
          else
            exit 1
          fi 