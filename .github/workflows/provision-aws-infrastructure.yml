name: Provision AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_ROLE_NAME:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      DEV_S3_BUCKET:
        required: true
      PROD_S3_BUCKET:
        required: true
      DEV_CLOUDFRONT_ID:
        required: true
      PROD_CLOUDFRONT_ID:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_NAME: ${{ secrets.AWS_ROLE_NAME }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NODE_ENV: ${{ inputs.environment }}
      APP_NAME: 'octonius'
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME || 'dev.octonius.com' }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Install CDK
        run: |
          npm install -g aws-cdk

      - name: Preprocess policy files
        run: |
          for policy_file in cdk/*-policy.json; do
            sed -i "s/\${AWS_ACCOUNT_ID}/${{ env.AWS_ACCOUNT_ID }}/g" "$policy_file"
            sed -i "s/\${AWS_REGION}/${{ env.AWS_REGION }}/g" "$policy_file"
            sed -i "s/\${NODE_ENV}/${{ env.NODE_ENV }}/g" "$policy_file"
            sed -i "s/\${DEV_S3_BUCKET}/${{ secrets.DEV_S3_BUCKET }}/g" "$policy_file"
            sed -i "s/\${PROD_S3_BUCKET}/${{ secrets.PROD_S3_BUCKET }}/g" "$policy_file"
          done

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build
        run: npm run build

      - name: Create/Update IAM Policy for CDK CloudFormation Execution
        run: |
          create_or_update_policy() {
            local policy_name=$1
            local policy_file=$2
            local description=$3
            local account_id="${{ env.AWS_ACCOUNT_ID }}"
            local expected_policy_arn="arn:aws:iam::${account_id}:policy/${policy_name}"

            if aws iam get-policy --policy-arn ${expected_policy_arn} > /dev/null 2>&1; then
              POLICY_VERSIONS_JSON=$(aws iam list-policy-versions --policy-arn "${expected_policy_arn}")
              VERSION_COUNT=$(echo "${POLICY_VERSIONS_JSON}" | jq '.Versions | length')

              if [ "${VERSION_COUNT}" -ge 5 ]; then
                OLDEST_NON_DEFAULT_VERSION_ID=$(echo "${POLICY_VERSIONS_JSON}" | \
                  jq -r '.Versions | sort_by(.CreateDate) | map(select(.IsDefaultVersion == false)) | .[0].VersionId // null')

                if [ -n "${OLDEST_NON_DEFAULT_VERSION_ID}" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "null" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "" ]; then
                  aws iam delete-policy-version --policy-arn "${expected_policy_arn}" --version-id "${OLDEST_NON_DEFAULT_VERSION_ID}"
                fi
              fi

              aws iam create-policy-version --policy-arn "${expected_policy_arn}" --policy-document file://${policy_file} --set-as-default
            else
              aws iam create-policy --policy-name ${policy_name} --policy-document file://${policy_file} --description "${description}"
            fi
          }

          create_or_update_policy "${{ inputs.environment }}-cdk-base-policy" "cdk/cdk-base-policy.json" "Base policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-cloudformation-policy" "cdk/cdk-cloudformation-policy.json" "CloudFormation policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-s3-policy" "cdk/cdk-s3-policy.json" "S3 policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-iam-policy" "cdk/cdk-iam-policy.json" "IAM policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-services-policy" "cdk/cdk-services-policy.json" "Services policy for CDK operations"
          create_or_update_policy "${{ inputs.environment }}-cdk-network-policy" "cdk/cdk-network-policy.json" "Network policy for CDK operations"

          # Construct the actual policy ARNs
          ACCOUNT_ID="${{ env.AWS_ACCOUNT_ID }}"
          BASE_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-base-policy"
          CLOUDFORMATION_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-cloudformation-policy"
          S3_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-s3-policy"
          IAM_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-iam-policy"
          SERVICES_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-services-policy"
          NETWORK_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${{ inputs.environment }}-cdk-network-policy"

          echo "AWS_CDK_POLICY_ARN_FROM_FILE=${BASE_POLICY_ARN},${CLOUDFORMATION_POLICY_ARN},${S3_POLICY_ARN},${IAM_POLICY_ARN},${SERVICES_POLICY_ARN},${NETWORK_POLICY_ARN}" >> $GITHUB_ENV
          
          # Debug: Show the constructed policy ARNs
          echo "Constructed policy ARNs: ${BASE_POLICY_ARN},${CLOUDFORMATION_POLICY_ARN},${S3_POLICY_ARN},${IAM_POLICY_ARN},${SERVICES_POLICY_ARN},${NETWORK_POLICY_ARN}"
        shell: bash

      - name: Bootstrap CDK
        run: |
          echo "Using policy ARNs: ${AWS_CDK_POLICY_ARN_FROM_FILE}"
          cdk bootstrap --cloudformation-execution-policies "${AWS_CDK_POLICY_ARN_FROM_FILE}"

      - name: CDK Deploy
        env:
          NODE_ENV: ${{ inputs.environment }}
        run: |
          cdk deploy --all --require-approval never 