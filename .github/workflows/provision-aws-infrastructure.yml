name: Provision AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_ROLE_NAME:
        required: true
      AWS_ACCOUNT_ID:
        required: true

jobs:
  deploy-cdk:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_NAME: ${{ secrets.AWS_ROLE_NAME }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      NODE_ENV: ${{ inputs.environment }}
      APP_NAME: 'octonius'
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME || 'dev.octonius.com' }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Install CDK
        run: |
          npm install -g aws-cdk@2.99.1
          cdk --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build
        run: npm run build

      - name: Create/Update IAM Policy for CDK CloudFormation Execution
        run: |
          POLICY_NAME="${{ inputs.environment }}-cdk-deploy-policy"
          POLICY_FILE_PATH="cdk/cdk-deploy-policy.json"
          ACCOUNT_ID="${{ env.AWS_ACCOUNT_ID }}"
          EXPECTED_POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${POLICY_NAME}"

          echo "Ensuring IAM policy ${POLICY_NAME} is up-to-date from ${POLICY_FILE_PATH}"
          echo "Expected Policy ARN: ${EXPECTED_POLICY_ARN}"

          if aws iam get-policy --policy-arn ${EXPECTED_POLICY_ARN} > /dev/null 2>&1; then
            echo "Policy ${POLICY_NAME} found. Managing versions and updating."

            # List versions and count them
            POLICY_VERSIONS_JSON=$(aws iam list-policy-versions --policy-arn "${EXPECTED_POLICY_ARN}")
            VERSION_COUNT=$(echo "${POLICY_VERSIONS_JSON}" | jq '.Versions | length')

            echo "Current version count: ${VERSION_COUNT}"
            echo "Policy versions details:"
            echo "${POLICY_VERSIONS_JSON}" | jq '.Versions[] | {VersionId, IsDefaultVersion, CreateDate}'

            # If version count is at the limit (e.g., 5)
            if [ "${VERSION_COUNT}" -ge 5 ]; then
              echo "Version limit (5) reached. Deleting oldest non-default version."
              
              # Get VersionId of the oldest non-default version
              OLDEST_NON_DEFAULT_VERSION_ID=$(echo "${POLICY_VERSIONS_JSON}" | \
                jq -r '.Versions | sort_by(.CreateDate) | map(select(.IsDefaultVersion == false)) | .[0].VersionId // null')

              if [ -n "${OLDEST_NON_DEFAULT_VERSION_ID}" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "null" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "" ]; then
                echo "Deleting oldest non-default version: ${OLDEST_NON_DEFAULT_VERSION_ID}"
                aws iam delete-policy-version --policy-arn "${EXPECTED_POLICY_ARN}" --version-id "${OLDEST_NON_DEFAULT_VERSION_ID}"
                if [ $? -ne 0 ]; then
                  echo "Failed to delete old policy version ${OLDEST_NON_DEFAULT_VERSION_ID}. Exiting."
                  exit 1
                fi
                echo "Successfully deleted version ${OLDEST_NON_DEFAULT_VERSION_ID}"
              else
                echo "ERROR: Could not find a non-default version to delete."
                echo "This is unusual - all 5 versions appear to be default or there's a parsing issue."
                echo "Attempting to proceed with policy update anyway..."
              fi
            fi

            # Now, create the new version and set it as default
            echo "Creating new policy version and setting as default."
            VERSION_INFO=$(aws iam create-policy-version --policy-arn "${EXPECTED_POLICY_ARN}" --policy-document file://${POLICY_FILE_PATH} --set-as-default)
            if [ $? -ne 0 ]; then
              echo "Failed to create new version for policy ${POLICY_NAME}. Exiting."
              exit 1
            fi
            echo "New version created and set as default: $VERSION_INFO"
          else
            echo "Policy ${POLICY_NAME} not found. Creating it."
            POLICY_INFO=$(aws iam create-policy --policy-name ${POLICY_NAME} --policy-document file://${POLICY_FILE_PATH} --description "Policy for CDK CloudFormation execution, managed by GitHub Actions for environment ${{ inputs.environment }}")
            if [ $? -ne 0 ]; then
              echo "Failed to create policy ${POLICY_NAME}. Exiting."
              exit 1
            fi
            echo "Policy ${POLICY_NAME} created: $POLICY_INFO"
          fi
          
          echo "Successfully prepared policy ${EXPECTED_POLICY_ARN}"
          echo "AWS_CDK_POLICY_ARN_FROM_FILE=${EXPECTED_POLICY_ARN}" >> $GITHUB_ENV
        shell: bash

      - name: Bootstrap CDK
        run: |
          echo "Bootstrapping CDK for environment: ${{ inputs.environment }}"
          
          # Check if bootstrap is already done
          if aws cloudformation describe-stacks --stack-name CDKToolkit > /dev/null 2>&1; then
            echo "CDK bootstrap stack already exists, checking if update is needed..."
            BOOTSTRAP_VERSION=$(aws ssm get-parameter --name "/cdk-bootstrap/${inputs.environment}/version" --query "Parameter.Value" --output text 2>/dev/null || echo "0")
            if [ "$BOOTSTRAP_VERSION" != "2" ]; then
              echo "Updating CDK bootstrap stack..."
              npx cdk bootstrap --cloudformation-execution-policies ${{ env.AWS_CDK_POLICY_ARN_FROM_FILE }} --verbose
            else
              echo "CDK bootstrap stack is up to date"
            fi
          else
            echo "Creating new CDK bootstrap stack..."
            npx cdk bootstrap --cloudformation-execution-policies ${{ env.AWS_CDK_POLICY_ARN_FROM_FILE }} --verbose
          fi
          
          if [ $? -ne 0 ]; then
            echo "CDK bootstrap failed. Exiting."
            exit 1
          fi
          
          # Store bootstrap version
          aws ssm put-parameter \
            --name "/cdk-bootstrap/${inputs.environment}/version" \
            --value "2" \
            --type String \
            --overwrite || true
          
          echo "CDK bootstrap completed successfully."

      - name: Deploy CDK stack
        run: |
          echo "Deploying CDK stack for environment: ${{ inputs.environment }}"
          
          # Ensure we're using the right context
          npx cdk context --clear
          
          # Deploy with explicit approval
          npx cdk deploy --require-approval never --cloudformation-execution-policies ${{ env.AWS_CDK_POLICY_ARN_FROM_FILE }} --verbose
          
          if [ $? -ne 0 ]; then
            echo "CDK deploy failed. Exiting."
            exit 1
          fi
          
          echo "CDK deploy completed successfully." 