name: Provision AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      job_to_run:
        description: 'Specific job to run (optional - runs all if not specified)'
        required: false
        type: choice
        options:
          - all
          - build
          - policy
          - deploy
        default: 'all'
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
      job_to_run:
        description: 'Specific job to run'
        required: false
        type: string
        default: 'all'
    secrets:
      AWS_REGION:
        required: true
      AWS_ROLE_NAME:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      DEV_S3_BUCKET:
        required: true
      PROD_S3_BUCKET:
        required: true
      DEV_CLOUDFRONT_ID:
        required: true
      PROD_CLOUDFRONT_ID:
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ROLE_NAME: ${{ secrets.AWS_ROLE_NAME }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  NODE_ENV: ${{ inputs.environment }}
  APP_NAME: 'octonius'
  DOMAIN_NAME: ${{ vars.DOMAIN_NAME || 'dev.octonius.com' }}
  DEV_S3_BUCKET: ${{ secrets.DEV_S3_BUCKET }}
  PROD_S3_BUCKET: ${{ secrets.PROD_S3_BUCKET }}

jobs:
  # Job 1: Build and prepare artifacts
  build:
    name: ðŸ—ï¸ Build & Prepare
    runs-on: ubuntu-latest
    if: inputs.job_to_run == 'all' || inputs.job_to_run == 'build' || contains(fromJSON('["policy", "deploy"]'), inputs.job_to_run)
    environment: ${{ inputs.environment }}
    outputs:
      build-cache-key: ${{ steps.cache-key.outputs.key }}
      environment: ${{ inputs.environment }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¥ Install dependencies
        run: npm install

      - name: ðŸ› ï¸ Install CDK
        run: npm install -g aws-cdk

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ“ Preprocess policy files
        run: |
          echo "Processing policy files for environment: ${{ inputs.environment }}"
          
          # Create processed policies directory
          mkdir -p processed-policies
          
          # Process each policy file
          for policy_file in cdk/*-policy.json; do
            if [[ -f "$policy_file" ]]; then
              policy_name=$(basename "$policy_file")
              echo "Processing $policy_file -> processed-policies/$policy_name"
              
              # Substitute variables in policy files
              sed "s/\${AWS_ACCOUNT_ID}/${{ env.AWS_ACCOUNT_ID }}/g; \
                   s/\${AWS_REGION}/${{ env.AWS_REGION }}/g; \
                   s/\${NODE_ENV}/${{ env.NODE_ENV }}/g; \
                   s/\${DEV_S3_BUCKET}/${{ secrets.DEV_S3_BUCKET }}/g; \
                   s/\${PROD_S3_BUCKET}/${{ secrets.PROD_S3_BUCKET }}/g" \
                   "$policy_file" > "processed-policies/$policy_name"
              
              echo "âœ… Processed: $policy_name"
            fi
          done
          
          # Verify processed files
          echo "ðŸ“‹ Processed policy files:"
          ls -la processed-policies/

      - name: ðŸ”‘ Generate cache key
        id: cache-key
        run: |
          # Generate cache key based on dependencies and code
          CACHE_KEY="build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('cdk/**') }}-${{ github.sha }}"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "Generated cache key: $CACHE_KEY"

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.environment }}
          path: |
            dist/
            processed-policies/
            package*.json
            cdk.json
            cdk/
            scripts/
            tsconfig.json
          retention-days: 1

      - name: âœ… Build summary
        run: |
          echo "### ðŸ—ï¸ Build Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **CDK Version**: $(cdk --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Key**: ${{ steps.cache-key.outputs.key }}" >> $GITHUB_STEP_SUMMARY

  # Job 2: Create and update IAM policies
  policy:
    name: ðŸ” Manage IAM Policies
    runs-on: ubuntu-latest
    needs: build
    if: (inputs.job_to_run == 'all' || inputs.job_to_run == 'policy' || inputs.job_to_run == 'deploy') && !failure()
    environment: ${{ inputs.environment }}
    outputs:
      policy-arns: ${{ steps.create-policies.outputs.policy_arns }}
    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ inputs.environment }}

      - name: ðŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Create/Update IAM Policies
        id: create-policies
        run: |
          echo "Creating/updating IAM policies for ${{ inputs.environment }} environment..."
          
          # Function to create or update a policy
          create_or_update_policy() {
            local policy_name=$1
            local policy_file=$2
            local description=$3
            local account_id="${{ env.AWS_ACCOUNT_ID }}"
            local expected_policy_arn="arn:aws:iam::${account_id}:policy/${policy_name}"

            echo "ðŸ”„ Processing policy: $policy_name"

            if aws iam get-policy --policy-arn ${expected_policy_arn} > /dev/null 2>&1; then
              echo "  ðŸ“ Policy exists, updating..."
              
              # Clean up old versions if needed
              POLICY_VERSIONS_JSON=$(aws iam list-policy-versions --policy-arn "${expected_policy_arn}")
              VERSION_COUNT=$(echo "${POLICY_VERSIONS_JSON}" | jq '.Versions | length')

              if [ "${VERSION_COUNT}" -ge 5 ]; then
                OLDEST_NON_DEFAULT_VERSION_ID=$(echo "${POLICY_VERSIONS_JSON}" | \
                  jq -r '.Versions | sort_by(.CreateDate) | map(select(.IsDefaultVersion == false)) | .[0].VersionId // null')

                if [ -n "${OLDEST_NON_DEFAULT_VERSION_ID}" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "null" ] && [ "${OLDEST_NON_DEFAULT_VERSION_ID}" != "" ]; then
                  echo "  ðŸ—‘ï¸ Removing oldest policy version: ${OLDEST_NON_DEFAULT_VERSION_ID}"
                  aws iam delete-policy-version --policy-arn "${expected_policy_arn}" --version-id "${OLDEST_NON_DEFAULT_VERSION_ID}"
                fi
              fi

              aws iam create-policy-version --policy-arn "${expected_policy_arn}" --policy-document file://${policy_file} --set-as-default
              echo "  âœ… Policy updated: $policy_name"
            else
              echo "  ðŸ†• Creating new policy..."
              aws iam create-policy --policy-name ${policy_name} --policy-document file://${policy_file} --description "${description}"
              echo "  âœ… Policy created: $policy_name"
            fi
            
            echo "${expected_policy_arn}"
          }

          # Create/update all policies
          POLICY_ARNS=""
          
          BASE_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-base-policy" "processed-policies/cdk-base-policy.json" "Base policy for CDK operations")
          CLOUDFORMATION_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-cloudformation-policy" "processed-policies/cdk-cloudformation-policy.json" "CloudFormation policy for CDK operations")
          S3_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-s3-policy" "processed-policies/cdk-s3-policy.json" "S3 policy for CDK operations")
          IAM_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-iam-policy" "processed-policies/cdk-iam-policy.json" "IAM policy for CDK operations")
          SERVICES_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-services-policy" "processed-policies/cdk-services-policy.json" "Services policy for CDK operations")
          NETWORK_POLICY_ARN=$(create_or_update_policy "${{ inputs.environment }}-cdk-network-policy" "processed-policies/cdk-network-policy.json" "Network policy for CDK operations")

          # Combine all policy ARNs
          POLICY_ARNS="${BASE_POLICY_ARN},${CLOUDFORMATION_POLICY_ARN},${S3_POLICY_ARN},${IAM_POLICY_ARN},${SERVICES_POLICY_ARN},${NETWORK_POLICY_ARN}"
          
          echo "policy_arns=${POLICY_ARNS}" >> $GITHUB_OUTPUT
          echo "AWS_CDK_POLICY_ARN_FROM_FILE=${POLICY_ARNS}" >> $GITHUB_ENV
          
          echo "### ðŸ” Policy Management Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Policies Created/Updated**: 6" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy ARNs**: \`${POLICY_ARNS}\`" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy infrastructure
  deploy:
    name: ðŸš€ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [build, policy]
    if: inputs.job_to_run == 'all' || inputs.job_to_run == 'deploy'
    environment: ${{ inputs.environment }}
    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ inputs.environment }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¥ Restore dependencies
        run: npm install

      - name: ðŸ› ï¸ Install CDK
        run: npm install -g aws-cdk

      - name: ðŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”‘ Set up deployment environment
        run: |
          # Set CDK policy ARNs from previous job
          echo "AWS_CDK_POLICY_ARN_FROM_FILE=${{ needs.policy.outputs.policy-arns }}" >> $GITHUB_ENV
          
          # Make scripts executable
          chmod +x scripts/*.sh
          
          # Verify environment setup
          echo "ðŸ” Environment verification:"
          echo "- CDK Version: $(cdk --version)"
          echo "- Node Version: $(node --version)"
          echo "- Working Directory: $(pwd)"
          echo "- Available files: $(ls -la)"
          
          echo "### ðŸš€ Deployment Setup" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Account**: ${{ env.AWS_ACCOUNT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš€ Deploy Infrastructure
        run: |
          echo "Starting infrastructure deployment..."
          
          ./scripts/deploy-infrastructure.sh \
            --env ${{ inputs.environment }} \
            --region ${{ env.AWS_REGION }} \
            --verbose

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          # Get deployment status from the tracker
          if [[ -f "final-deployment-manifest.json" ]]; then
            DEPLOYMENT_STATUS=$(jq -r '.status' final-deployment-manifest.json)
            DEPLOYMENT_ID=$(jq -r '.deploymentId' final-deployment-manifest.json)
            DEPLOYED_STACKS=$(jq -r '.deployedStacks' final-deployment-manifest.json)
            
            echo "### ðŸ“Š Deployment Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: $DEPLOYMENT_STATUS" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployment ID**: $DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployed Stacks**: $DEPLOYED_STACKS" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "No deployment manifest found - deployment may have failed early" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-${{ inputs.environment }}
          path: |
            *deployment*.json
            logs/
          retention-days: 7 