name: ðŸ—ï¸ Build Angular Application

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment to build for'
      working-directory:
        required: false
        type: string
        default: 'services/octonius-web'
        description: 'Working directory for the build'
      node_version:
        required: false
        type: string
        default: '20.x'
        description: 'Node.js version to use'

jobs:
  validate-env:
    name: ðŸ” Validate Environment Variables
    uses: ./.github/workflows/validate-env.yml
    with:
      required_vars: NODE_VERSION
      job_name: angular-build

  build:
    name: ðŸ—ï¸ Build Angular Application
    needs: validate-env
    runs-on: ubuntu-latest
    outputs:
      build_path: ${{ steps.outputs.build_path }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: ðŸ“¦ Install Dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        working-directory: ${{ inputs.working-directory }}
        run: |
          # Set environment-specific configuration
          case "${{ inputs.environment }}" in
            prod)
              CONFIG="production"
              ;;
            *)
              CONFIG="development"
              ;;
          esac
          
          # Build the application
          npm run build -- --configuration=$CONFIG
          
          # Set output
          echo "build_path=${{ inputs.working-directory }}/dist" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: angular-build-${{ inputs.environment }}
          path: ${{ inputs.working-directory }}/dist
          retention-days: 1 