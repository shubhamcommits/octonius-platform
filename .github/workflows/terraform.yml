name: ðŸ—ï¸ 100% Pipeline-Native Terraform

on:
  push:
    branches: 
      - master
      - development
      - 'feature/*'
      - 'hotfix/*'
    paths: 
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches: 
      - master
      - development
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (auto-detected from branch if not provided)'
        required: false
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VERSION: '1.6.0'
  PROJECT_NAME: 'octonius'

jobs:
  setup:
    name: ðŸ”§ Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      state_bucket: ${{ steps.env.outputs.state_bucket }}
      should-apply: ${{ steps.action.outputs.should-apply }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Determine Environment & Bucket
        id: env
        run: |
          # Get branch name
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          
          # Use manual environment if provided
          if [[ -n "${{ github.event.inputs.environment }}" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            # Convert branch to environment
            case "$BRANCH" in
              master)
                ENV="prod"
                ;;
              development|dev)
                ENV="dev"
                ;;
              feature/*)
                ENV=$(echo "$BRANCH" | sed 's|feature/|feature-|' | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')
                ;;
              hotfix/*)
                ENV=$(echo "$BRANCH" | sed 's|hotfix/|hotfix-|' | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')
                ;;
              *)
                ENV=$(echo "$BRANCH" | tr '/' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')
                ;;
            esac
          fi
          
          # Determine S3 bucket based on environment
          case "$ENV" in
            prod)
              BUCKET_NAME="${{ secrets.PROD_S3_BUCKET }}"
              ;;
            dev)
              BUCKET_NAME="${{ secrets.DEV_S3_BUCKET }}"
              ;;
            *)
              # For feature branches, use dev bucket with different key path
              BUCKET_NAME="${{ secrets.DEV_S3_BUCKET }}"
              ;;
          esac
          
          echo "Branch: $BRANCH"
          echo "Environment: $ENV"
          echo "S3 Bucket: $BUCKET_NAME"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "state_bucket=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: ðŸŽ¯ Determine Action
        id: action
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.action }}" == "apply" || "${{ github.event.inputs.action }}" == "destroy" ]]; then
              echo "should-apply=true" >> $GITHUB_OUTPUT
            else
              echo "should-apply=false" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "should-apply=true" >> $GITHUB_OUTPUT
          else
            echo "should-apply=false" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ðŸ” Terraform Format Check
        run: terraform fmt -check -recursive terraform/

  plan:
    name: ðŸ“‹ Plan (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ—ƒï¸ Create DynamoDB Table (State Locking)
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          TABLE_NAME="${ENV}-${{ env.PROJECT_NAME }}-terraform-locks-${{ secrets.AWS_REGION }}"
          
          echo "ðŸ—ƒï¸ Setting up DynamoDB table for state locking: $TABLE_NAME"
          
          # Create DynamoDB table if it doesn't exist
          if ! aws dynamodb describe-table --table-name "$TABLE_NAME" 2>/dev/null >/dev/null; then
            echo "ðŸ”¨ Creating DynamoDB table: $TABLE_NAME"
            
            aws dynamodb create-table \
              --table-name "$TABLE_NAME" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
              --tags \
                Key=Environment,Value="$ENV" \
                Key=Project,Value="${{ env.PROJECT_NAME }}" \
                Key=Purpose,Value=terraform-locks \
                Key=Repository,Value="${{ vars.REPO_NAME }}"
            
            echo "â³ Waiting for DynamoDB table to become active..."
            aws dynamodb wait table-exists --table-name "$TABLE_NAME"
            echo "âœ… DynamoDB table created and active"
          else
            echo "âœ… DynamoDB table already exists: $TABLE_NAME"
          fi
          
          echo "ðŸ“¦ Using existing S3 bucket: ${{ needs.setup.outputs.state_bucket }}"

      - name: ðŸ“ Generate Backend Configuration
        run: |
          mkdir -p terraform/config
          
          # Generate backend configuration as a separate .tf file
          cat > terraform/backend.tf << EOF
          # Backend Configuration - Generated by GitHub Actions
          # Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          terraform {
            backend "s3" {
              bucket         = "${{ needs.setup.outputs.state_bucket }}"
              key            = "terraform/${{ needs.setup.outputs.environment }}/terraform.tfstate"
              region         = "${{ secrets.AWS_REGION }}"
              encrypt        = true
              dynamodb_table = "${{ needs.setup.outputs.environment }}-${{ env.PROJECT_NAME }}-terraform-locks-${{ secrets.AWS_REGION }}"
            }
          }
          EOF
          
          # Also create the .hcl file for reference
          cat > terraform/config/backend.hcl << EOF
          bucket         = "${{ needs.setup.outputs.state_bucket }}"
          key            = "terraform/${{ needs.setup.outputs.environment }}/terraform.tfstate"
          region         = "${{ secrets.AWS_REGION }}"
          encrypt        = true
          dynamodb_table = "${{ needs.setup.outputs.environment }}-${{ env.PROJECT_NAME }}-terraform-locks-${{ secrets.AWS_REGION }}"
          EOF

      - name: ðŸ“ Generate Variables Configuration
        run: |
          # Determine environment-specific settings
          ENV="${{ needs.setup.outputs.environment }}"
          
          case "$ENV" in
            prod)
              VPC_CIDR="10.0.0.0/16"
              PUBLIC_SUBNETS='["10.0.1.0/24", "10.0.2.0/24"]'
              PRIVATE_SUBNETS='["10.0.10.0/24", "10.0.20.0/24"]'
              SINGLE_NAT="false"
              ;;
            dev)
              VPC_CIDR="10.1.0.0/16"
              PUBLIC_SUBNETS='["10.1.1.0/24", "10.1.2.0/24"]'
              PRIVATE_SUBNETS='["10.1.10.0/24", "10.1.20.0/24"]'
              SINGLE_NAT="true"
              ;;
            *)
              # For feature branches and other environments
              ENV_HASH=$(echo -n "$ENV" | md5sum | cut -c1-2)
              SECOND_OCTET=$((0x$ENV_HASH % 240 + 10))
              VPC_CIDR="10.${SECOND_OCTET}.0.0/16"
              PUBLIC_SUBNETS="[\"10.${SECOND_OCTET}.1.0/24\", \"10.${SECOND_OCTET}.2.0/24\"]"
              PRIVATE_SUBNETS="[\"10.${SECOND_OCTET}.10.0/24\", \"10.${SECOND_OCTET}.20.0/24\"]"
              SINGLE_NAT="true"
              ;;
          esac
          
          cat > terraform/config/terraform.tfvars << EOF
          environment  = "$ENV"
          project_name = "${{ env.PROJECT_NAME }}"
          aws_region   = "${{ secrets.AWS_REGION }}"
          
          vpc_cidr           = "$VPC_CIDR"
          public_subnets     = $PUBLIC_SUBNETS
          private_subnets    = $PRIVATE_SUBNETS
          single_nat_gateway = $SINGLE_NAT
          EOF

      - name: ðŸ“ Generate Locals Configuration
        run: |
          cat > terraform/locals.tf << EOF
          # Dynamic Terraform Locals - Generated by GitHub Actions
          # Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          locals {
            # Environment and project info
            environment  = var.environment
            project_name = var.project_name
            aws_region   = var.aws_region
            account_id   = "${{ vars.AWS_ACCOUNT_ID }}"
            
            # Computed names and identifiers
            name_prefix = "\${local.environment}-\${local.project_name}"
            
            # Resource naming
            vpc_name = "\${local.name_prefix}-vpc"
            
            # Backend resources (for reference)
            state_bucket         = "${{ needs.setup.outputs.state_bucket }}"
            state_dynamodb_table = "\${local.environment}-\${local.project_name}-terraform-locks-\${local.aws_region}"
            
            # Common tags applied to all resources
            common_tags = {
              Environment = local.environment
              Project     = local.project_name
              ManagedBy   = "terraform"
              Repository  = "${{ vars.REPO_NAME }}"
              Branch      = local.environment # Since env is derived from branch
              Account     = local.account_id
              Region      = local.aws_region
            }
            
            # Environment-specific configurations
            is_production = local.environment == "prod"
            is_development = local.environment == "dev"
            is_feature_branch = !local.is_production && !local.is_development
          }
          EOF

      - name: ðŸ—ï¸ Initialize Terraform
        working-directory: terraform
        run: |
          echo "ðŸ”„ Initializing Terraform for ${{ needs.setup.outputs.environment }} environment..."
          terraform init

      - name: âœ… Validate Terraform
        working-directory: terraform
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          terraform validate

      - name: ðŸ“‹ Plan Terraform Changes
        working-directory: terraform
        run: |
          echo "ðŸ“‹ Creating Terraform plan for ${{ needs.setup.outputs.environment }} environment..."
          terraform plan \
            -var-file=config/terraform.tfvars \
            -out=tfplan-${{ needs.setup.outputs.environment }} \
            -detailed-exitcode || exit_code=$?
          
          if [[ $exit_code -eq 1 ]]; then
            echo "âŒ Terraform plan failed"
            exit 1
          elif [[ $exit_code -eq 2 ]]; then
            echo "âœ… Plan created with changes for ${{ needs.setup.outputs.environment }}"
            echo "has-changes=true" >> $GITHUB_ENV
          else
            echo "âœ… No changes detected for ${{ needs.setup.outputs.environment }}"
            echo "has-changes=false" >> $GITHUB_ENV
          fi

      - name: ðŸ’¾ Upload Plan Artifact
        if: env.has-changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.setup.outputs.environment }}
          path: terraform/tfplan-${{ needs.setup.outputs.environment }}
          retention-days: 7

      - name: ðŸ“¤ Upload Configuration Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-config-${{ needs.setup.outputs.environment }}
          path: terraform/config/
          retention-days: 1

      - name: ðŸ“ Add Plan Summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ needs.setup.outputs.environment }}';
            const hasChanges = '${{ env.has-changes }}' === 'true';
            
            const summary = `## ðŸ—ï¸ Terraform Plan Summary
            
            **Environment**: \`${environment}\` (computed from branch: \`${{ github.ref_name }}\`)
            **Changes**: ${hasChanges ? 'âœ… Changes detected' : 'âœ… No changes'}
            **State Bucket**: \`${{ needs.setup.outputs.state_bucket }}\`
            
            ${hasChanges ? 'ðŸ“‹ Plan artifact uploaded for review' : ''}
            
            *This environment was automatically computed from the branch name.*
            *Using existing S3 bucket with auto-created DynamoDB table for locking.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  apply:
    name: ðŸš€ Apply (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, plan]
    if: needs.setup.outputs.should-apply == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“‹ Download Configuration
        uses: actions/download-artifact@v4
        with:
          name: terraform-config-${{ needs.setup.outputs.environment }}
          path: terraform/config/

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ—ï¸ Initialize Terraform
        working-directory: terraform
        run: |
          echo "ðŸ”„ Initializing Terraform for ${{ needs.setup.outputs.environment }} environment..."
          terraform init

      - name: ðŸ“¥ Download Plan Artifact
        if: github.event.inputs.action != 'destroy'
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.setup.outputs.environment }}
          path: terraform/

      - name: ðŸš€ Apply or Destroy Infrastructure
        working-directory: terraform
        run: |
          if [[ "${{ github.event.inputs.action }}" == "destroy" ]]; then
            echo "ðŸ—‚ï¸ Destroying infrastructure for ${{ needs.setup.outputs.environment }} environment..."
            terraform destroy -var-file=config/terraform.tfvars -auto-approve
          else
            echo "ðŸš€ Applying infrastructure for ${{ needs.setup.outputs.environment }} environment..."
            terraform apply tfplan-${{ needs.setup.outputs.environment }}
          fi

      - name: ðŸ“Š Show Infrastructure Outputs
        if: github.event.inputs.action != 'destroy'
        working-directory: terraform
        run: |
          echo "ðŸ“Š Infrastructure outputs for ${{ needs.setup.outputs.environment }}:"
          terraform output -json

      - name: ðŸ“ Deployment Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }} (computed from branch: ${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.inputs.action || 'apply' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **State Bucket**: ${{ needs.setup.outputs.state_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ 100% Pipeline-Native:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: \`${{ needs.setup.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Using existing S3 bucket with auto-created DynamoDB table" >> $GITHUB_STEP_SUMMARY
          echo "- Zero external scripts used" >> $GITHUB_STEP_SUMMARY 