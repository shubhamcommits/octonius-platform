name: Deploy Full Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      deploy_infrastructure:
        description: 'Deploy CDK infrastructure'
        required: true
        default: true
        type: boolean
      deploy_application:
        description: 'Deploy application code'
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    if: ${{ inputs.deploy_infrastructure }}
    uses: ./.github/workflows/provision-aws-infrastructure.yml
    with:
      environment: ${{ inputs.environment }}
    secrets: inherit

  deploy-application:
    needs: [deploy-infrastructure]
    # Run even if deploy-infrastructure was skipped
    if: ${{ always() && (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') && inputs.deploy_application }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_NAME: ${{ secrets.AWS_ROLE_NAME }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ENVIRONMENT: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3 and CloudFront
        env:
          S3_BUCKET: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_S3_BUCKET || secrets.DEV_S3_BUCKET }}
          CF_DISTRIBUTION: ${{ env.ENVIRONMENT == 'prod' && secrets.PROD_CLOUDFRONT_ID || secrets.DEV_CLOUDFRONT_ID }}
        run: |
          echo "Deploying application to ${{ env.ENVIRONMENT }} environment"
          
          # Check if S3 bucket is configured
          if [ -z "${S3_BUCKET}" ]; then
            echo "Error: S3 bucket not configured for ${{ env.ENVIRONMENT }} environment"
            echo "Please run the Configure AWS-GitHub Integration workflow first"
            exit 1
          fi
          
          echo "S3 Bucket: $S3_BUCKET"
          echo "CloudFront Distribution: ${CF_DISTRIBUTION:-Not configured}"
          
          # Deploy to S3
          aws s3 sync dist/ s3://${S3_BUCKET}/ --delete
          
          # Invalidate CloudFront if configured
          if [ -n "${CF_DISTRIBUTION}" ]; then
            echo "Invalidating CloudFront distribution..."
            aws cloudfront create-invalidation \
              --distribution-id ${CF_DISTRIBUTION} \
              --paths "/*"
          else
            echo "No CloudFront distribution configured for this environment"
          fi 