name: Setup AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      aws_account_id:
        description: 'AWS Account ID'
        required: true
        type: string
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'eu-central-1'
        type: string
      dev_s3_bucket:
        description: 'Development S3 Bucket Name (must exist)'
        required: true
        type: string
      prod_s3_bucket:
        description: 'Production S3 Bucket Name (must exist)'
        required: true
        type: string
      github_repository:
        description: 'GitHub Repository (owner/repo)'
        required: true
        default: 'Octonius/octonius-platform'
        type: string
      dev_cloudfront_id:
        description: 'Development CloudFront Distribution ID'
        required: true
        type: string
      prod_cloudfront_id:
        description: 'Production CloudFront Distribution ID'
        required: true
        type: string

env:
  AWS_REGION: ${{ inputs.aws_region }}
  AWS_ACCOUNT_ID: ${{ inputs.aws_account_id }}
  AWS_ROLE_NAME: github-actions-role
  GITHUB_REPOSITORY: ${{ inputs.github_repository }}

permissions:
  id-token: write
  contents: read

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check and Create OIDC provider
        run: |
          PROVIDER_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
          
          if aws iam get-open-id-connect-provider --open-id-connect-provider-arn "$PROVIDER_ARN" >/dev/null 2>&1; then
            echo "OIDC provider already exists"
          else
            echo "Creating OIDC provider..."
            aws iam create-open-id-connect-provider \
              --url https://token.actions.githubusercontent.com \
              --client-id-list sts.amazonaws.com
          fi

      - name: Create trust policy
        run: |
          cat > trust-policy.json << 'EOF'
          {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
                      },
                      "Action": "sts:AssumeRoleWithWebIdentity",
                      "Condition": {
                          "StringLike": {
                              "token.actions.githubusercontent.com:sub": "repo:${GITHUB_REPOSITORY}:*"
                          },
                          "StringEquals": {
                              "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                          }
                      }
                  }
              ]
          }
          EOF

      - name: Check and Create IAM role
        run: |
          if aws iam get-role --role-name ${AWS_ROLE_NAME} >/dev/null 2>&1; then
            echo "IAM role ${AWS_ROLE_NAME} already exists"
            echo "Updating trust policy..."
            aws iam update-assume-role-policy \
              --role-name ${AWS_ROLE_NAME} \
              --policy-document file://trust-policy.json
          else
            echo "Creating IAM role ${AWS_ROLE_NAME}..."
            aws iam create-role \
              --role-name ${AWS_ROLE_NAME} \
              --assume-role-policy-document file://trust-policy.json
          fi

      - name: Check and Update IAM role policy
        env:
          DEV_S3_BUCKET: ${{ inputs.dev_s3_bucket }}
          PROD_S3_BUCKET: ${{ inputs.prod_s3_bucket }}
          DEV_CLOUDFRONT_ID: ${{ inputs.dev_cloudfront_id }}
          PROD_CLOUDFRONT_ID: ${{ inputs.prod_cloudfront_id }}
        run: |
          cat > role-policy.json << EOF
          {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Action": [
                          "iam:GetRole",
                          "iam:CreateRole",
                          "iam:UpdateAssumeRolePolicy",
                          "iam:PutRolePolicy",
                          "iam:GetOpenIDConnectProvider",
                          "iam:CreateOpenIDConnectProvider"
                      ],
                      "Resource": [
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:role/github-actions-role",
                          "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Action": [
                          "s3:PutObject",
                          "s3:GetObject",
                          "s3:ListBucket",
                          "s3:DeleteObject",
                          "cloudfront:CreateInvalidation"
                      ],
                      "Resource": [
                          "arn:aws:s3:::${DEV_S3_BUCKET}",
                          "arn:aws:s3:::${DEV_S3_BUCKET}/*",
                          "arn:aws:s3:::${PROD_S3_BUCKET}",
                          "arn:aws:s3:::${PROD_S3_BUCKET}/*",
                          "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${DEV_CLOUDFRONT_ID}",
                          "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${PROD_CLOUDFRONT_ID}"
                      ]
                  }
              ]
          }
          EOF

          # Always update the policy to ensure it's current
          aws iam put-role-policy \
            --role-name ${AWS_ROLE_NAME} \
            --policy-name github-actions-policy \
            --policy-document file://role-policy.json

      - name: Generate GitHub App Token
        uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Authenticate GitHub CLI
        run: |
          # Configure GitHub CLI to use the token
          echo "${{ steps.generate-token.outputs.token }}" | gh auth login --with-token

      - name: Set GitHub Variables
        run: |
          # Function to set variable with error handling
          set_var() {
            local name=$1
            local value=$2
            if ! gh variable set "$name" --body "$value" --repo "${GITHUB_REPOSITORY}"; then
              echo "Failed to set variable: $name"
              exit 1
            fi
            echo "Successfully set variable: $name"
          }
          
          # Set common AWS account variables
          set_var "AWS_ACCOUNT_ID" "${AWS_ACCOUNT_ID}"
          set_var "AWS_ROLE_NAME" "${AWS_ROLE_NAME}"
          set_var "AWS_REGION" "${AWS_REGION}"
          set_var "REPO_NAME" "${GITHUB_REPOSITORY}"
          
          # Set environment-specific bucket names
          set_var "DEV_S3_BUCKET" "${{ inputs.dev_s3_bucket }}"
          set_var "PROD_S3_BUCKET" "${{ inputs.prod_s3_bucket }}"
          
          # Set CloudFront IDs
          set_var "DEV_CLOUDFRONT_ID" "${{ inputs.dev_cloudfront_id }}"
          set_var "PROD_CLOUDFRONT_ID" "${{ inputs.prod_cloudfront_id }}"