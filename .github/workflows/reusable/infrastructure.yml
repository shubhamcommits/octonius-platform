name: ðŸ—ï¸ Infrastructure Management

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment to deploy to'
      action:
        required: true
        type: string
        description: 'Action to perform (plan/apply/destroy)'
      aws_region:
        required: true
        type: string
        description: 'AWS region to deploy to'
      project_name:
        required: true
        type: string
        description: 'Project name'
    secrets:
      aws_access_key:
        required: true
      aws_secret_key:
        required: true
      prod_s3_bucket:
        required: true
      dev_s3_bucket:
        required: true

jobs:
  infrastructure:
    name: ðŸ—ï¸ Infrastructure Management
    runs-on: ubuntu-latest
    outputs:
      web_s3_bucket_name: ${{ steps.outputs.web_s3_bucket_name }}
      web_cloudfront_distribution_id: ${{ steps.outputs.web_cloudfront_distribution_id }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws_access_key }}
          aws-secret-access-key: ${{ secrets.aws_secret_key }}
          aws-region: ${{ inputs.aws_region }}

      - name: ðŸ—ƒï¸ Create DynamoDB Table (State Locking)
        run: |
          ENV="${{ inputs.environment }}"
          TABLE_NAME="${ENV}-${{ inputs.project_name }}-terraform-locks-${{ inputs.aws_region }}"
          
          echo "ðŸ—ƒï¸ Setting up DynamoDB table for state locking: $TABLE_NAME"
          
          # Create DynamoDB table if it doesn't exist
          if ! aws dynamodb describe-table --table-name "$TABLE_NAME" 2>/dev/null >/dev/null; then
            echo "ðŸ”¨ Creating DynamoDB table: $TABLE_NAME"
            
            aws dynamodb create-table \
              --table-name "$TABLE_NAME" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1 \
              --tags \
                Key=Environment,Value="$ENV" \
                Key=Project,Value="${{ inputs.project_name }}" \
                Key=Purpose,Value=terraform-locks \
                Key=Repository,Value="${{ github.repository }}"
            
            echo "â³ Waiting for DynamoDB table to become active..."
            aws dynamodb wait table-exists --table-name "$TABLE_NAME"
            echo "âœ… DynamoDB table created and active"
          else
            echo "âœ… DynamoDB table already exists: $TABLE_NAME"
          fi

      - name: ðŸ“ Generate Terraform Configuration
        run: |
          mkdir -p terraform/config
          
          # Determine S3 bucket based on environment
          case "${{ inputs.environment }}" in
            prod)
              BUCKET_NAME="${{ secrets.prod_s3_bucket }}"
              ;;
            *)
              BUCKET_NAME="${{ secrets.dev_s3_bucket }}"
              ;;
          esac
          
          # Generate backend configuration
          cat > terraform/backend.tf << EOF
          # Backend Configuration - Generated by GitHub Actions
          # Generated on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          terraform {
            backend "s3" {
              bucket         = "$BUCKET_NAME"
              key            = "terraform/${{ inputs.environment }}/terraform.tfstate"
              region         = "${{ inputs.aws_region }}"
              encrypt        = true
              dynamodb_table = "${{ inputs.environment }}-${{ inputs.project_name }}-terraform-locks-${{ inputs.aws_region }}"
            }
          }
          EOF
          
          # Generate variables configuration
          cat > terraform/config/terraform.tfvars << EOF
          environment  = "${{ inputs.environment }}"
          project_name = "${{ inputs.project_name }}"
          aws_region   = "${{ inputs.aws_region }}"
          EOF

      - name: ðŸ—ï¸ Initialize Terraform
        working-directory: terraform
        run: terraform init

      - name: âœ… Validate Terraform
        working-directory: terraform
        run: terraform validate

      - name: ðŸ“‹ Plan Terraform Changes
        if: inputs.action == 'plan'
        working-directory: terraform
        run: |
          terraform plan \
            -var-file=config/terraform.tfvars \
            -out=tfplan-${{ inputs.environment }} \
            -detailed-exitcode || exit_code=$?
          
          if [[ $exit_code -eq 1 ]]; then
            echo "âŒ Terraform plan failed"
            exit 1
          elif [[ $exit_code -eq 2 ]]; then
            echo "âœ… Plan created with changes for ${{ inputs.environment }}"
            echo "has-changes=true" >> $GITHUB_ENV
          else
            echo "âœ… No changes detected for ${{ inputs.environment }}"
            echo "has-changes=false" >> $GITHUB_ENV
          fi

      - name: ðŸš€ Apply Infrastructure
        if: inputs.action == 'apply'
        working-directory: terraform
        run: |
          if [[ -f "tfplan-${{ inputs.environment }}" ]]; then
            echo "ðŸš€ Applying saved plan..."
            terraform apply tfplan-${{ inputs.environment }}
          else
            echo "ðŸ“‹ No saved plan found. Creating new plan and applying..."
            terraform plan -var-file=config/terraform.tfvars -out=tfplan-${{ inputs.environment }}
            terraform apply tfplan-${{ inputs.environment }}
          fi

      - name: ðŸ—‘ï¸ Destroy Infrastructure
        if: inputs.action == 'destroy'
        working-directory: terraform
        run: terraform destroy -var-file=config/terraform.tfvars -auto-approve

      - name: ðŸ“Š Extract Outputs
        id: outputs
        working-directory: terraform
        run: |
          # Get outputs as JSON
          OUTPUTS=$(terraform output -json)
          
          # Extract specific values
          echo "web_s3_bucket_name=$(echo $OUTPUTS | jq -r '.web_s3_bucket_name.value')" >> $GITHUB_OUTPUT
          echo "web_cloudfront_distribution_id=$(echo $OUTPUTS | jq -r '.web_cloudfront_distribution_id.value')" >> $GITHUB_OUTPUT 