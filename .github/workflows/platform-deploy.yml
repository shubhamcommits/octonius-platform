name: üöÄ 100% Pipeline-Native Platform Deployment

on:
  push:
    branches:
      - master
      - development
      - 'feature/*'
      - 'hotfix/*'
    paths:
      - 'services/octonius-web/**'
      - 'terraform/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - master
      - development
    paths:
      - 'services/octonius-web/**'
      - 'terraform/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - prod
          - dev
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

# Prevent parallel deployments of the same environment
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.environment || 'auto' }}
  cancel-in-progress: true

# Define all environment variables at the top level
env:
  # Terraform Configuration
  TF_VERSION: '1.6.0'
  PROJECT_NAME: 'octonius'
  
  # AWS Configuration
  AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
  AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  
  # S3 Bucket Configuration
  PROD_S3_BUCKET: ${{ secrets.PROD_S3_BUCKET }}
  DEV_S3_BUCKET: ${{ secrets.DEV_S3_BUCKET }}
  
  # Node.js Configuration
  NODE_VERSION: '20.x'
  
  # Docker Configuration
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  WEB_IMAGE_NAME: 'octonius-web'

# Set minimum required permissions
permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  setup:
    name: üîß Setup Environment
    uses: ./.github/workflows/reusable/setup-environment.yml

  determine-action:
    name: ü§î Determine Action
    needs: setup
    uses: ./.github/workflows/reusable/determine-action.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      action: ${{ github.event.inputs.action || 'plan' }}

  infrastructure:
    name: üèóÔ∏è Infrastructure Management
    needs: [setup, determine-action]
    uses: ./.github/workflows/reusable/infrastructure.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      action: ${{ needs.determine-action.outputs.should-apply }}
      aws_region: ${{ env.AWS_REGION }}
      project_name: ${{ env.PROJECT_NAME }}
    secrets:
      aws_access_key: ${{ env.AWS_ACCESS_KEY }}
      aws_secret_key: ${{ env.AWS_SECRET_KEY }}
      prod_s3_bucket: ${{ env.PROD_S3_BUCKET }}
      dev_s3_bucket: ${{ env.DEV_S3_BUCKET }}

  build-web:
    name: üèóÔ∏è Build Web Application
    needs: setup
    uses: ./.github/workflows/reusable/angular-build.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      node_version: ${{ env.NODE_VERSION }}
      working_directory: 'services/octonius-web'

  docker-images:
    name: üê≥ Docker Image Management
    needs: [setup, build-web]
    uses: ./.github/workflows/reusable/docker-images.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      web_dist_path: ${{ needs.build-web.outputs.dist_path }}
      docker_registry: ${{ env.DOCKER_REGISTRY }}
      web_image_name: ${{ env.WEB_IMAGE_NAME }}
    secrets:
      aws_access_key: ${{ env.AWS_ACCESS_KEY }}
      aws_secret_key: ${{ env.AWS_SECRET_KEY }}
      aws_region: ${{ env.AWS_REGION }}

  deploy-web:
    name: üöÄ Deploy Web Assets
    needs: [setup, infrastructure, build-web]
    uses: ./.github/workflows/reusable/web-deploy.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      s3_bucket: ${{ needs.infrastructure.outputs.web_s3_bucket_name }}
      cloudfront_id: ${{ needs.infrastructure.outputs.web_cloudfront_distribution_id }}
      aws_region: ${{ env.AWS_REGION }}
    secrets:
      aws_access_key: ${{ env.AWS_ACCESS_KEY }}
      aws_secret_key: ${{ env.AWS_SECRET_KEY }}

  summary:
    name: üìä Deployment Summary
    needs: [infrastructure, docker-images, deploy-web]
    uses: ./.github/workflows/reusable/deployment-summary.yml
    with:
      environment: ${{ needs.setup.outputs.environment }}
      web_s3_bucket: ${{ needs.infrastructure.outputs.web_s3_bucket_name }}
      web_cloudfront_id: ${{ needs.infrastructure.outputs.web_cloudfront_distribution_id }}
      web_image_uri: ${{ needs.docker-images.outputs.web_image_uri }} 