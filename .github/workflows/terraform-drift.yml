name: ðŸ” 100% Pipeline-Native Terraform Drift Detection

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check for drift (leave empty to check all active environments)'
        required: false
        type: string

env:
  TF_VERSION: '1.6.0'
  PROJECT_NAME: 'octonius'

jobs:
  detect-drift:
    name: ðŸ” Drift Detection
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Only check master and development environments for scheduled runs
        # Feature environments are typically short-lived
        environment: [prod, dev]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: ðŸ“ Generate Terraform Configuration
        run: |
          # Use manual environment if provided, otherwise use matrix environment
          if [[ -n "${{ github.event.inputs.environment }}" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="${{ matrix.environment }}"
          fi
          
          # Determine S3 bucket based on environment and secrets
          case "$ENV" in
            prod)
              BUCKET_NAME="${{ secrets.PROD_S3_BUCKET }}"
              ;;
            dev)
              BUCKET_NAME="${{ secrets.DEV_S3_BUCKET }}"
              ;;
            *)
              # For feature branches, use dev bucket with different key path
              BUCKET_NAME="${{ secrets.DEV_S3_BUCKET }}"
              ;;
          esac
          
          # Validate bucket name is not empty
          if [[ -z "$BUCKET_NAME" ]]; then
            echo "âŒ ERROR: S3 bucket name is empty for environment: $ENV"
            case "$ENV" in
              prod)
                echo "Missing secret: PROD_S3_BUCKET"
                ;;
              *)
                echo "Missing secret: DEV_S3_BUCKET"
                ;;
            esac
            exit 1
          fi
          
          echo "ðŸŽ¯ Generating configuration for environment: $ENV"
          echo "ðŸŽ¯ Using S3 bucket: $BUCKET_NAME"
          
          mkdir -p terraform/config
          
          # Generate backend configuration
          cat > terraform/config/backend.hcl << EOF
          bucket         = "$BUCKET_NAME"
          key            = "terraform/${ENV}/terraform.tfstate"
          region         = "${{ secrets.AWS_REGION }}"
          encrypt        = true
          dynamodb_table = "${ENV}-${{ env.PROJECT_NAME }}-terraform-locks-${{ secrets.AWS_REGION }}"
          EOF
          
          # Determine environment-specific settings
          case "$ENV" in
            prod)
              VPC_CIDR="10.0.0.0/16"
              PUBLIC_SUBNETS='["10.0.1.0/24", "10.0.2.0/24"]'
              PRIVATE_SUBNETS='["10.0.10.0/24", "10.0.20.0/24"]'
              SINGLE_NAT="false"
              ;;
            dev)
              VPC_CIDR="10.1.0.0/16"
              PUBLIC_SUBNETS='["10.1.1.0/24", "10.1.2.0/24"]'
              PRIVATE_SUBNETS='["10.1.10.0/24", "10.1.20.0/24"]'
              SINGLE_NAT="true"
              ;;
            *)
              # For feature branches and other environments
              ENV_HASH=$(echo -n "$ENV" | md5sum | cut -c1-2)
              SECOND_OCTET=$((0x$ENV_HASH % 240 + 10))
              VPC_CIDR="10.${SECOND_OCTET}.0.0/16"
              PUBLIC_SUBNETS="[\"10.${SECOND_OCTET}.1.0/24\", \"10.${SECOND_OCTET}.2.0/24\"]"
              PRIVATE_SUBNETS="[\"10.${SECOND_OCTET}.10.0/24\", \"10.${SECOND_OCTET}.20.0/24\"]"
              SINGLE_NAT="true"
              ;;
          esac
          
          # Generate variables configuration
          cat > terraform/config/terraform.tfvars << EOF
          environment  = "$ENV"
          project_name = "${{ env.PROJECT_NAME }}"
          aws_region   = "${{ secrets.AWS_REGION }}"
          
          vpc_cidr           = "$VPC_CIDR"
          public_subnets     = $PUBLIC_SUBNETS
          private_subnets    = $PRIVATE_SUBNETS
          single_nat_gateway = $SINGLE_NAT
          EOF

      - name: ðŸ”„ Initialize Terraform
        working-directory: terraform
        run: |
          echo "ðŸ”„ Initializing Terraform for ${{ matrix.environment }} environment..."
          terraform init -backend-config=config/backend.hcl

      - name: ðŸ“‹ Check for Drift
        id: drift-check
        working-directory: terraform
        continue-on-error: true
        run: |
          echo "ðŸ” Checking for infrastructure drift in ${{ matrix.environment }}..."
          
          # Run terraform plan to detect drift
          terraform plan \
            -var-file=config/terraform.tfvars \
            -detailed-exitcode \
            -out=drift-plan || exit_code=$?
          
          if [[ $exit_code -eq 0 ]]; then
            echo "âœ… No drift detected"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          elif [[ $exit_code -eq 2 ]]; then
            echo "âš ï¸ Infrastructure drift detected!"
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            
            # Save plan for analysis
            terraform show -no-color drift-plan > drift-plan.txt
          else
            echo "âŒ Error running terraform plan"
            echo "drift_detected=error" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“Š Analyze Drift
        if: steps.drift-check.outputs.drift_detected == 'true'
        working-directory: terraform
        run: |
          echo "ðŸ“Š Analyzing drift details..."
          
          # Extract key information from the plan
          echo "## ðŸ” Infrastructure Drift Detected" > ../drift-summary.md
          echo "" >> ../drift-summary.md
          echo "**Environment**: ${{ matrix.environment }}" >> ../drift-summary.md
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ../drift-summary.md
          echo "" >> ../drift-summary.md
          echo "### ðŸ“‹ Plan Output:" >> ../drift-summary.md
          echo '```' >> ../drift-summary.md
          cat drift-plan.txt >> ../drift-summary.md
          echo '```' >> ../drift-summary.md

      - name: ðŸ“¤ Upload Drift Report
        if: steps.drift-check.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ matrix.environment }}-${{ github.run_id }}
          path: |
            terraform/drift-plan.txt
            drift-summary.md
          retention-days: 30

      - name: ðŸš¨ Create Issue for Drift
        if: steps.drift-check.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read drift summary if it exists
            let driftSummary = '';
            try {
              driftSummary = fs.readFileSync('drift-summary.md', 'utf8');
            } catch (error) {
              driftSummary = 'Drift detected but summary not available.';
            }
            
            const environment = '${{ matrix.environment }}';
            const issueTitle = `ðŸ” Infrastructure Drift Detected - ${environment} Environment`;
            
            const issueBody = `${driftSummary}
            
            ## ðŸ”§ Recommended Actions
            
            1. **Review Changes**: Examine the drift plan above to understand what changed
            2. **Investigate Cause**: Determine if changes were made outside of Terraform
            3. **Update Code**: If changes are intentional, update Terraform code to match
            4. **Apply Fix**: Run terraform apply to restore desired state
            
            ## ðŸš€ Quick Fix Commands
            
            \`\`\`bash
            # Deploy via GitHub Actions workflow_dispatch
            # Or manually if needed:
            cd terraform
            terraform init -backend-config=config/backend.hcl
            terraform apply -var-file=config/terraform.tfvars
            \`\`\`
            
            ## ðŸ“‹ Environment Details
            
            - **Environment**: ${environment}
            - **Detection Time**: ${new Date().toISOString()}
            - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            
            *This issue was automatically created by the 100% Pipeline-Native Terraform Drift Detection workflow.*`;
            
            // Check if there's already an open drift issue for this environment
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['terraform-drift', `environment:${environment}`],
              state: 'open'
            });
            
            if (issues.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['terraform-drift', `environment:${environment}`, 'infrastructure']
              });
              console.log(`Created new drift issue for ${environment} environment`);
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `## ðŸ”„ New Drift Detection\n\n${driftSummary}\n\n**Detection Time**: ${new Date().toISOString()}`
              });
              console.log(`Updated existing drift issue for ${environment} environment`);
            }

      - name: ðŸ“§ Notify on Drift
        if: steps.drift-check.outputs.drift_detected == 'true'
        run: |
          echo "::warning title=Infrastructure Drift Detected::Drift detected in ${{ matrix.environment }} environment. Check the created issue for details."

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ” Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: " >> $GITHUB_STEP_SUMMARY
          
          case "${{ steps.drift-check.outputs.drift_detected }}" in
            "false")
              echo "âœ… No drift detected" >> $GITHUB_STEP_SUMMARY
              ;;
            "true")
              echo "âš ï¸ Drift detected - Issue created" >> $GITHUB_STEP_SUMMARY
              ;;
            "error")
              echo "âŒ Error during drift check" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY 