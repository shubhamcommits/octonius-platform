<div class="flex flex-col gap-6 animate-fadeIn">
    <!-- Skeleton Loader -->
    <ng-container *ngIf="isLoading">
      <div class="space-y-6 animate-pulse">
        <!-- Skeleton Post Creation Card -->
        <div class="card bg-base-100 shadow-lg border border-base-200">
          <div class="card-body flex items-start gap-4">
            <div class="avatar">
              <div class="w-12 h-12 bg-base-300 rounded-full"></div>
            </div>
            <div class="flex-1">
              <div class="h-10 bg-base-300 rounded mb-2"></div>
              <div class="flex gap-2 mt-2">
                <div class="w-8 h-8 bg-base-300 rounded-full"></div>
                <div class="w-8 h-8 bg-base-300 rounded-full"></div>
                <div class="w-16 h-8 bg-base-300 rounded"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- Skeleton Feed -->
        <div class="flex flex-col gap-4">
          <div *ngFor="let i of [1,2,3,4]" class="card bg-base-100 shadow-lg border border-base-200">
            <div class="card-body">
              <div class="flex items-center gap-3 mb-2">
                <div class="avatar">
                  <div class="w-10 h-10 bg-base-300 rounded-full"></div>
                </div>
                <div>
                  <div class="h-4 w-32 bg-base-300 rounded mb-1"></div>
                  <div class="h-3 w-24 bg-base-300 rounded"></div>
                </div>
              </div>
              <div class="py-4">
                <div class="h-4 w-full bg-base-300 rounded mb-2"></div>
                <div class="h-4 w-3/4 bg-base-300 rounded mb-2"></div>
                <div class="h-4 w-1/2 bg-base-300 rounded"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Info Banner -->
    <div class="bg-base-200 border border-base-300 rounded-lg p-4 flex items-center gap-4" *ngIf="!isLoading">
      <div class="bg-primary/20 p-2 rounded-full">
        <lucide-icon name="Bell" class="text-primary"></lucide-icon>
      </div>
      <p class="text-base-content/80">
        The activity is the main communication channel for the group members. No more emails, no more texts...
      </p>
    </div>
  
    <!-- Post Creation Card -->
    <div class="card bg-base-100 shadow-lg border border-base-200" *ngIf="!isLoading">
      <div class="card-body">
        <div class="flex items-start gap-4">
          <div class="avatar">
            <div class="w-12 rounded-full">
              <img [src]="getUserAvatarUrl(currentUser)" alt="User Avatar" />
            </div>
          </div>
          <div class="flex-1">
            <app-tiptap-editor
              [config]="{
                placeholder: 'What\'s on your mind, User?',
                showToolbar: true,
                showBubbleMenu: true,
                showCharacterCount: true,
                maxHeight: '200px',
                minHeight: '120px',
                toolbarItems: ['bold', 'italic', 'underline', 'bulletList', 'orderedList', 'link', 'image', 'emoji', 'table', 'code']
              }"
              [(ngModel)]="newPostContent"
              name="newPostContent">
            </app-tiptap-editor>
            <div class="flex justify-between items-center mt-2">
              <div class="flex gap-2">
                <button class="btn btn-ghost btn-sm btn-circle" disabled><lucide-icon name="Paperclip" class="w-5 h-5"></lucide-icon></button>
                <button class="btn btn-ghost btn-sm btn-circle" disabled><lucide-icon name="AtSign" class="w-5 h-5"></lucide-icon></button>
              </div>
              <button type="button" class="btn btn-primary btn-sm" (click)="createPost()" [disabled]="!newPostContent.trim() || isSubmitting">Post</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Feed -->
    <div class="flex flex-col gap-4" *ngIf="!isLoading && posts.length > 0">
      <div *ngFor="let post of posts" class="card bg-base-100 shadow-lg border border-base-200">
        <div class="card-body relative">
          <!-- Post Header -->
          <div class="flex items-center gap-3">
            <div class="avatar">
              <div class="w-10 rounded-full">
                <img [src]="getUserAvatarUrl(post.user)" [alt]="post.user?.first_name || 'User'" />
              </div>
            </div>
            <div class="flex-1">
              <p class="font-semibold">{{ post.user?.first_name }} {{ post.user?.last_name }}</p>
              <p class="text-xs text-base-content/60">{{ post.created_at | date:'medium' }}</p>
            </div>
          </div>
          <!-- Post Content -->
          <div class="py-4">
            <p class="text-base-content/90" style="white-space: pre-wrap;" [appRichHtml]="post.content"></p>
          </div>
          <!-- Post Actions: Likes and Comments -->
          <div class="flex items-center justify-between mt-2">
            <div class="flex items-center gap-6">
              <!-- Like Button and Count -->
              <button class="flex items-center gap-1 text-base-content/80 transition-colors hover:text-red-500"
                      [ngClass]="{'text-red-500': post.liked_by_current_user}"
                      (click)="toggleLike(post)">
                <lucide-icon name="Heart" [class.filled]="post.liked_by_current_user"></lucide-icon>
                <span>{{ post.like_count }}</span>
              </button>
              <!-- Comment Count -->
              <button class="flex items-center gap-1 text-base-content/80 transition-colors hover:text-blue-500"
                      (click)="toggleComments(post)">
                <lucide-icon name="MessageCircle"></lucide-icon>
                <span>{{ post.comment_count }}</span>
              </button>
            </div>
            <!-- 3 Dots Dropdown -->
            <div class="relative">
              <button class="btn btn-ghost btn-sm btn-circle" (click)="$event.stopPropagation(); post.showMenu = !post.showMenu">
                <lucide-icon name="MoreHorizontal"></lucide-icon>
              </button>
              <div *ngIf="post.showMenu" class="absolute right-0 bottom-full mb-2 z-10 bg-base-100 border border-base-300 rounded-lg shadow-lg py-2 w-32"
                   (click)="$event.stopPropagation()">
                <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-base-200" (click)="editPost(post); post.showMenu = false">Edit</button>
                <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-error/10 text-error" (click)="deletePost(post); post.showMenu = false">Delete</button>
              </div>
            </div>
          </div>
          <!-- Comments Section -->
          <div *ngIf="post.showComments" class="mt-4 pt-4 border-t-2 border-base-200">
            <!-- Comments Header -->
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-sm font-semibold text-base-content/80">
                Comments ({{ post.comment_count || 0 }})
              </h4>
            </div>
            <!-- Loading Comments -->
            <div *ngIf="post.loadingComments" class="flex justify-center py-4">
              <span class="loading loading-spinner loading-sm"></span>
            </div>
            <!-- Comments List -->
            <div *ngIf="!post.loadingComments && post.comments" class="space-y-4 mb-4">
              <div *ngFor="let comment of post.comments" class="flex items-start gap-3">
                <div class="avatar">
                  <div class="w-9 rounded-full">
                    <img [src]="getUserAvatarUrl(comment.user)" [alt]="comment.user?.first_name || 'User'" />
                  </div>
                </div>
                <div class="flex-1">
                  <div class="bg-base-100 border border-base-300 rounded-lg px-4 py-3">
                    <div class="flex items-center gap-2 mb-1">
                      <p class="text-sm font-semibold">{{ comment.user?.first_name }} {{ comment.user?.last_name }}</p>
                      <span class="text-xs text-base-content/60">{{ comment.created_at | date:'medium' }}</span>
                    </div>
                    <div class="text-sm text-base-content/90 whitespace-pre-wrap" [appRichHtml]="comment.content"></div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Comment Input Box -->
            <div class="card bg-base-200 border border-base-300 mt-4">
              <div class="card-body p-4">
                <div class="flex items-start gap-3">
                  <div class="avatar">
                    <div class="w-10 rounded-full">
                      <img [src]="getUserAvatarUrl(currentUser)" alt="Your Avatar" />
                    </div>
                  </div>
                  <div class="flex-1">
                    <app-tiptap-editor
                      [config]="{
                        placeholder: 'What\'s on your mind, User?',
                        showToolbar: true,
                        showBubbleMenu: true,
                        showCharacterCount: true,
                        maxHeight: '200px',
                        minHeight: '120px',
                        toolbarItems: ['bold', 'italic', 'underline', 'bulletList', 'orderedList', 'link']
                      }"
                      [(ngModel)]="post.newComment"
                      name="post.newComment">
                    </app-tiptap-editor>
                    <div class="flex justify-between items-center mt-2">
                      <div class="flex gap-2">
                        <button class="btn btn-ghost btn-sm btn-circle" disabled>
                          <lucide-icon name="Paperclip" class="w-4 h-4"></lucide-icon>
                        </button>
                        <button class="btn btn-ghost btn-sm btn-circle" disabled>
                          <lucide-icon name="AtSign" class="w-4 h-4"></lucide-icon>
                        </button>
                      </div>
                      <button 
                        type="button" 
                        class="btn btn-primary btn-sm" 
                        (click)="addComment(post)"
                        [disabled]="!post.newComment?.trim() || !!post.submittingComment">
                        <span *ngIf="!post.submittingComment">Post</span>
                        <span *ngIf="post.submittingComment" class="loading loading-spinner loading-xs"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="!isLoading && posts.length === 0" class="text-center text-base-content/60 py-8">
      No activity posts yet. Be the first to post!
    </div>
  </div>
  