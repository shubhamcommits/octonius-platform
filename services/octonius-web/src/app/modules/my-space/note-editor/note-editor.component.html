<div class="fixed inset-0 bg-base-100 text-base-content z-50 animate-fadeIn">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex flex-col h-full animate-fadeIn">
    <!-- Header Skeleton -->
    <div class="flex-none bg-base-100 border-b border-base-300 px-6 py-4">
      <div class="flex items-center justify-between mb-4">
        <div class="w-16 h-8 bg-base-300 rounded animate-pulse"></div>
        <div class="flex items-center gap-4">
          <div class="w-24 h-6 bg-base-300 rounded animate-pulse"></div>
          <div class="w-20 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
      </div>
      <div class="w-3/4 h-10 bg-base-300 rounded animate-pulse mx-auto"></div>
    </div>

    <!-- Toolbar Skeleton -->
    <div class="flex-none bg-base-100 border-b border-base-300 px-6 py-3">
      <div class="flex flex-wrap items-center gap-2">
        <div class="flex items-center gap-1">
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
        <div class="w-px h-6 bg-base-300"></div>
        <div class="w-24 h-8 bg-base-300 rounded animate-pulse"></div>
        <div class="w-px h-6 bg-base-300"></div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
        <div class="w-px h-6 bg-base-300"></div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
        <div class="w-px h-6 bg-base-300"></div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
        <div class="w-px h-6 bg-base-300"></div>
        <div class="flex items-center gap-1">
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
          <div class="w-8 h-8 bg-base-300 rounded animate-pulse"></div>
        </div>
      </div>
    </div>

    <!-- Editor Content Skeleton -->
    <div class="flex-1 overflow-auto bg-base-100 px-6 py-8">
      <div class="space-y-4">
        <div class="w-full h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-3/4 h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-1/2 h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-full h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-2/3 h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-full h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-4/5 h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-1/3 h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-full h-6 bg-base-300 rounded animate-pulse"></div>
        <div class="w-2/3 h-6 bg-base-300 rounded animate-pulse"></div>
      </div>
    </div>

    <!-- Status Bar Skeleton -->
    <div class="flex-none bg-base-200 border-t border-base-300 px-6 py-2">
      <div class="flex items-center justify-between text-sm text-base-content/60">
        <div class="flex items-center gap-4">
          <div class="w-24 h-4 bg-base-300 rounded animate-pulse"></div>
          <div class="w-20 h-4 bg-base-300 rounded animate-pulse"></div>
          <div class="w-32 h-4 bg-base-300 rounded animate-pulse"></div>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-12 h-4 bg-base-300 rounded animate-pulse"></div>
          <div class="w-6 h-6 bg-base-300 rounded-full animate-pulse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="flex-1 flex items-center justify-center h-full">
    <div class="text-center">
      <p class="text-error mb-4">{{ error }}</p>
      <button class="btn btn-primary" (click)="goBackToFiles()">Go Back</button>
    </div>
  </div>

  <!-- Professional Editor Interface -->
  <div *ngIf="!isLoading && !error" class="flex flex-col h-full">
    <!-- Combined Header and Toolbar - Full Width -->
    <div class="flex-none bg-base-100 border-b border-base-300 px-6 py-4">
      <div class="flex items-center justify-between gap-4">
        <!-- Left side: Back button and toolbar -->
        <div class="flex items-center gap-4">
          <button 
            class="btn btn-ghost btn-sm"
            (click)="goBackToFiles()"
            title="Back to Files">
            <lucide-icon name="ArrowLeft" class="w-5 h-5"></lucide-icon>
            Back
          </button>
          
          <!-- Toolbar -->
          <div class="flex flex-wrap items-center gap-2">
        <!-- Undo/Redo -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            [disabled]="!canUndo()"
            (click)="undo()"
            title="Undo (Ctrl+Z)">
            <lucide-icon name="Undo" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [disabled]="!canRedo()"
            (click)="redo()"
            title="Redo (Ctrl+Y)">
            <lucide-icon name="Redo" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- Heading Dropdown -->
        <div class="dropdown">
          <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
            <span class="text-sm font-medium">{{ getCurrentHeadingText() }}</span>
            <lucide-icon name="ChevronDown" class="w-4 h-4"></lucide-icon>
          </div>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border border-base-300">
            <li><a (click)="setParagraph()" [class.active]="isActive('paragraph')">Paragraph</a></li>
            <li><a (click)="setHeading(1)" [class.active]="isActive('heading', { level: 1 })">Heading 1</a></li>
            <li><a (click)="setHeading(2)" [class.active]="isActive('heading', { level: 2 })">Heading 2</a></li>
            <li><a (click)="setHeading(3)" [class.active]="isActive('heading', { level: 3 })">Heading 3</a></li>
            <li><a (click)="setHeading(4)" [class.active]="isActive('heading', { level: 4 })">Heading 4</a></li>
            <li><a (click)="setHeading(5)" [class.active]="isActive('heading', { level: 5 })">Heading 5</a></li>
            <li><a (click)="setHeading(6)" [class.active]="isActive('heading', { level: 6 })">Heading 6</a></li>
          </ul>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- Text Formatting -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('bold')"
            (click)="toggleBold()"
            title="Bold (Ctrl+B)">
            <lucide-icon name="Bold" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('italic')"
            (click)="toggleItalic()"
            title="Italic (Ctrl+I)">
            <lucide-icon name="Italic" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('underline')"
            (click)="toggleUnderline()"
            title="Underline (Ctrl+U)">
            <lucide-icon name="Underline" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('strike')"
            (click)="toggleStrike()"
            title="Strikethrough">
            <lucide-icon name="Strikethrough" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            (click)="clearFormatting()"
            title="Clear Formatting">
            <lucide-icon name="RemoveFormatting" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- Text Alignment -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive({ textAlign: 'left' })"
            (click)="setTextAlign('left')"
            title="Align Left">
            <lucide-icon name="AlignLeft" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive({ textAlign: 'center' })"
            (click)="setTextAlign('center')"
            title="Align Center">
            <lucide-icon name="AlignCenter" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive({ textAlign: 'right' })"
            (click)="setTextAlign('right')"
            title="Align Right">
            <lucide-icon name="AlignRight" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive({ textAlign: 'justify' })"
            (click)="setTextAlign('justify')"
            title="Justify">
            <lucide-icon name="AlignJustify" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- Lists -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('bulletList')"
            (click)="toggleBulletList()"
            title="Bullet List">
            <lucide-icon name="List" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('orderedList')"
            (click)="toggleOrderedList()"
            title="Numbered List">
            <lucide-icon name="ListOrdered" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('taskList')"
            (click)="toggleTaskList()"
            title="Task List">
            <lucide-icon name="ListTodo" class="w-4 h-4"></lucide-icon>
          </button>
          <!-- Debug button -->
          <button 
            class="btn btn-ghost btn-sm btn-error"
            (click)="debugListExtensions()"
            title="Debug Lists">
            <lucide-icon name="Bug" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- More Options -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('blockquote')"
            (click)="toggleBlockquote()"
            title="Quote">
            <lucide-icon name="Quote" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('codeBlock')"
            (click)="toggleCodeBlock()"
            title="Code Block">
            <lucide-icon name="Code" class="w-4 h-4"></lucide-icon>
          </button>
          <button 
            class="btn btn-ghost btn-sm"
            (click)="insertHorizontalRule()"
            title="Horizontal Rule">
            <lucide-icon name="Minus" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
        <div class="divider divider-horizontal"></div>
        <!-- Insert Options -->
        <div class="flex items-center gap-1">
          <button 
            class="btn btn-ghost btn-sm"
            (click)="insertTable()"
            title="Insert Table">
            <lucide-icon name="Table" class="w-4 h-4"></lucide-icon>
          </button>
          <div class="relative">
            <button 
              class="btn btn-ghost btn-sm image-btn"
              [disabled]="isUploadingImage"
              (click)="showImageOptions = !showImageOptions; showEmojiPicker = false; showGifPicker = false"
              title="Insert Image">
              <lucide-icon name="Image" class="w-4 h-4" *ngIf="!isUploadingImage"></lucide-icon>
              <span class="loading loading-spinner loading-xs" *ngIf="isUploadingImage"></span>
            </button>
            <!-- Image Options Dropdown -->
            <div class="absolute top-full left-0 mt-2 p-2 bg-base-100 border border-base-300 rounded-lg shadow-xl z-50 text-xs image-options-container"
                 *ngIf="showImageOptions">
              <div class="space-y-1">
                <button 
                  (click)="insertImageFromFile(); showImageOptions = false"
                  class="w-full text-left px-2 py-1 hover:bg-base-200 rounded flex items-center gap-2">
                  <lucide-icon name="Upload" class="w-3 h-3"></lucide-icon>
                  Upload Image
                </button>
                <button 
                  (click)="insertImageFromUrl(); showImageOptions = false"
                  class="w-full text-left px-2 py-1 hover:bg-base-200 rounded flex items-center gap-2">
                  <lucide-icon name="Link" class="w-3 h-3"></lucide-icon>
                  From URL
                </button>
              </div>
            </div>
            <!-- Image Upload Error Toast -->
            <div *ngIf="imageUploadError" 
                 class="absolute top-full left-0 mt-2 p-2 bg-error text-error-content rounded-lg shadow-lg z-50 text-xs max-w-xs">
              {{ imageUploadError }}
              <button (click)="clearImageUploadError()" class="ml-2 text-error-content hover:text-error-content/80">✕</button>
            </div>
          </div>
          <button 
            class="btn btn-ghost btn-sm"
            [class.btn-active]="isActive('link')"
            (click)="setLink()"
            title="Insert Link">
            <lucide-icon name="Link" class="w-4 h-4"></lucide-icon>
          </button>
          <div class="relative">
            <button 
              class="btn btn-ghost btn-sm emoji-picker-btn"
              [class.btn-active]="showEmojiPicker"
              (click)="showEmojiPicker = !showEmojiPicker; showGifPicker = false"
              title="Insert Emoji">
              <lucide-icon name="Smile" class="w-4 h-4"></lucide-icon>
            </button>
            <!-- Emoji Picker Dropdown -->
            <div class="emoji-picker-container absolute top-full left-0 mt-2 p-3 bg-base-100 border border-base-300 rounded-lg shadow-xl z-50 w-80"
                 *ngIf="showEmojiPicker">
              <div class="mb-2">
                <input 
                  type="text" 
                  [(ngModel)]="emojiSearchTerm"
                  placeholder="Search emojis..." 
                  class="input input-bordered input-sm w-full">
              </div>
              <div class="max-h-64 overflow-y-auto">
                <!-- Recently Used -->
                <div class="mb-3" *ngIf="recentEmojis.length > 0">
                  <h5 class="text-xs font-semibold text-base-content/70 mb-1">Recently Used</h5>
                  <div class="grid grid-cols-10 gap-1">
                    <button 
                      *ngFor="let emoji of recentEmojis"
                      (click)="insertEmoji(emoji)"
                      class="text-xl p-1 hover:bg-base-200 rounded cursor-pointer transition-colors"
                      [title]="emoji">
                      {{ emoji }}
                    </button>
                  </div>
                </div>
                <!-- Emoji Categories -->
                <div *ngFor="let category of emojiCategories" class="mb-3">
                  <h5 class="text-xs font-semibold text-base-content/70 mb-1">{{ category.name }}</h5>
                  <div class="grid grid-cols-10 gap-1">
                    <button 
                      *ngFor="let emoji of category.emojis"
                      (click)="insertEmoji(emoji)"
                      class="text-xl p-1 hover:bg-base-200 rounded cursor-pointer transition-colors"
                      [title]="emoji">
                      {{ emoji }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="relative">
            <button 
              class="btn btn-ghost btn-sm gif-picker-btn"
              [class.btn-active]="showGifPicker"
              (click)="showGifPicker = !showGifPicker; showEmojiPicker = false"
              title="Insert GIF">
              <lucide-icon name="FileImage" class="w-4 h-4"></lucide-icon>
            </button>
            <!-- GIF Picker Dropdown -->
            <div class="gif-picker-container absolute top-full left-0 mt-2 p-3 bg-base-100 border border-base-300 rounded-lg shadow-xl z-50 w-80"
                 *ngIf="showGifPicker">
              <div class="mb-2">
                <div class="join w-full">
                  <input 
                    type="text" 
                    [(ngModel)]="gifSearchTerm"
                    (keyup.enter)="searchGifs()"
                    placeholder="Search GIFs..." 
                    class="input input-bordered input-sm join-item flex-1">
                  <button 
                    class="btn btn-sm btn-primary join-item"
                    (click)="searchGifs()"
                    [disabled]="isLoadingGifs">
                    <lucide-icon name="Search" class="w-4 h-4" *ngIf="!isLoadingGifs"></lucide-icon>
                    <span class="loading loading-spinner loading-xs" *ngIf="isLoadingGifs"></span>
                  </button>
                </div>
              </div>
              <div class="max-h-64 overflow-y-auto">
                <div class="grid grid-cols-2 gap-2" *ngIf="gifSearchResults.length > 0">
                  <div 
                    *ngFor="let gif of gifSearchResults"
                    class="cursor-pointer hover:opacity-80 transition-opacity">
                    <img 
                      [src]="gif.url" 
                      [alt]="gif.title"
                      (click)="insertGif(gif.url)"
                      class="w-full h-24 object-cover rounded">
                  </div>
                </div>
                <div class="text-center text-base-content/50 py-8" *ngIf="gifSearchResults.length === 0 && !isLoadingGifs">
                  <lucide-icon name="Search" class="w-8 h-8 mx-auto mb-2 opacity-50"></lucide-icon>
                  <p class="text-sm">Search for GIFs to insert</p>
                </div>
                <div class="text-center py-8" *ngIf="isLoadingGifs">
                  <span class="loading loading-spinner loading-md"></span>
                </div>
              </div>
              <div class="text-xs text-base-content/50 mt-2">
                Powered by Giphy
              </div>
            </div>
          </div>
          <div class="w-px h-6 bg-base-300"></div>
        </div>
        <!-- Table Controls (shown only when in a table) -->
        <div class="divider divider-horizontal" *ngIf="isActive('table')"></div>
        <div class="dropdown dropdown-bottom" *ngIf="isActive('table')">
          <label tabindex="0" class="btn btn-ghost btn-sm">
            <lucide-icon name="Settings" class="w-4 h-4"></lucide-icon>
            Table
            <lucide-icon name="ChevronDown" class="w-3 h-3"></lucide-icon>
          </label>
          <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
            <li>
              <a (click)="addTableRow()">
                <lucide-icon name="Plus" class="w-4 h-4"></lucide-icon>
                Add Row Below
              </a>
            </li>
            <li>
              <a (click)="addTableRowBefore()">
                <lucide-icon name="Plus" class="w-4 h-4"></lucide-icon>
                Add Row Above
              </a>
            </li>
            <li>
              <a (click)="addTableColumn()">
                <lucide-icon name="Plus" class="w-4 h-4"></lucide-icon>
                Add Column Right
              </a>
            </li>
            <li>
              <a (click)="addTableColumnBefore()">
                <lucide-icon name="Plus" class="w-4 h-4"></lucide-icon>
                Add Column Left
              </a>
            </li>
            <li class="divider"></li>
            <li>
              <a (click)="deleteTableRow()">
                <lucide-icon name="Trash2" class="w-4 h-4"></lucide-icon>
                Delete Row
              </a>
            </li>
            <li>
              <a (click)="deleteTableColumn()">
                <lucide-icon name="X" class="w-4 h-4"></lucide-icon>
                Delete Column
              </a>
            </li>
            <li class="divider"></li>
            <li>
              <a (click)="toggleTableHeader()">
                <lucide-icon name="ToggleLeft" class="w-4 h-4"></lucide-icon>
                Toggle Header Row
              </a>
            </li>
            <li>
              <a (click)="mergeCells()">
                <lucide-icon name="Merge" class="w-4 h-4"></lucide-icon>
                Merge Cells
              </a>
            </li>
            <li>
              <a (click)="splitCell()">
                <lucide-icon name="Split" class="w-4 h-4"></lucide-icon>
                Split Cell
              </a>
            </li>
            <li class="divider"></li>
            <li>
              <a (click)="deleteTable()" class="text-error">
                <lucide-icon name="Trash" class="w-4 h-4"></lucide-icon>
                Delete Table
              </a>
            </li>
          </ul>
        </div>
          </div>
        </div>
        
        <!-- Right side: Help, Save status and button -->
        <div class="flex items-center gap-4">
          <!-- Help Button -->
          <button 
            class="btn btn-ghost btn-sm btn-circle"
            (click)="showHelpModal = true"
            title="Keyboard Shortcuts & Help">
            <lucide-icon name="Info" class="w-4 h-4"></lucide-icon>
          </button>
          <!-- Manual Save Button -->
          <button 
            class="btn btn-primary btn-sm"
            (click)="saveNow()"
            [disabled]="isSaving || saveStatus === 'saved'"
            title="Save Now (Ctrl+S)">
            <lucide-icon name="Save" class="w-4 h-4"></lucide-icon>
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Centered Content Area -->
    <div class="flex-1 overflow-auto bg-base-100 flex justify-center">
      <div class="w-full max-w-3xl px-6 py-8">
              <!-- Note Title -->
      <input 
        type="text" 
        [(ngModel)]="noteTitle"
        (input)="onTitleChange()"
        placeholder="Untitled Note"
        class="input input-ghost text-3xl font-bold w-full p-0 border-none focus:outline-none bg-transparent text-base-content placeholder-base-content/50 mb-8 text-center"
        maxlength="200">
        
        <!-- Editor Content Area -->
        <div class="relative">
          <div #editorElement class="tiptap-editor min-h-[400px] w-full"></div>
          
          <!-- Image Upload Loading Overlay -->
          <div *ngIf="isUploadingImage" class="absolute inset-0 bg-base-100/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-lg">
            <div class="flex flex-col items-center gap-3 p-6 bg-base-200 rounded-lg shadow-lg">
              <span class="loading loading-spinner loading-lg text-primary"></span>
              <span class="text-base text-base-content font-medium">Uploading image...</span>
              <div *ngIf="imageUploadProgress !== null" class="w-48 bg-base-300 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all duration-300" [style.width.%]="imageUploadProgress"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Status Bar - Full Width -->
    <div class="flex-none bg-base-200 border-t border-base-300 px-6 py-2">
      <div class="flex items-center justify-between text-sm text-base-content/60">
        <div class="flex items-center gap-4">
          <span>{{ getCharacterCount() }} characters</span>
          <span>{{ getWordCount() }} words</span>
          <span>Last edited: {{ lastEdited | date:'short' }}</span>
          <!-- Save Status -->
          <span class="divider divider-horizontal m-0"></span>
          <div class="flex items-center gap-2" [class]="getSaveStatusClass()">
            <span *ngIf="saveStatus === 'saving'" class="loading loading-spinner loading-xs"></span>
            <span>{{ getSaveStatusText() }}</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span>{{ createdByUser?.first_name || 'Unknown User' }} {{ createdByUser?.last_name || 'Unknown User' }}</span>
          <div class="avatar">
            <div class="w-6 h-6 rounded-full">
              <img [src]="getUserAvatarUrl(createdByUser)" [alt]="createdByUser?.first_name || createdByUser?.last_name || 'User'" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bubble Menu (hidden, will be positioned by Tiptap) -->
  <div #bubbleMenuElement class="bubble-menu">
    <div class="flex items-center gap-2 bg-base-200 border border-base-300 rounded-lg shadow-lg p-3">
      <!-- Bold -->
      <button 
        class="btn btn-ghost btn-sm"
        [class.btn-active]="isActive('bold')"
        (click)="toggleBold()"
        title="Bold">
        <lucide-icon name="Bold" class="w-4 h-4"></lucide-icon>
      </button>
      
      <!-- Italic -->
      <button 
        class="btn btn-ghost btn-sm"
        [class.btn-active]="isActive('italic')"
        (click)="toggleItalic()"
        title="Italic">
        <lucide-icon name="Italic" class="w-4 h-4"></lucide-icon>
      </button>
      
      <!-- Underline -->
      <button 
        class="btn btn-ghost btn-sm"
        [class.btn-active]="isActive('underline')"
        (click)="toggleUnderline()"
        title="Underline">
        <lucide-icon name="Underline" class="w-4 h-4"></lucide-icon>
      </button>
      
      <!-- Code -->
      <button 
        class="btn btn-ghost btn-sm"
        [class.btn-active]="isActive('code')"
        (click)="toggleCode()"
        title="Code">
        <lucide-icon name="Code" class="w-4 h-4"></lucide-icon>
      </button>
      
      <!-- Link -->
      <button 
        class="btn btn-ghost btn-sm"
        [class.btn-active]="isActive('link')"
        (click)="setLink()"
        title="Link">
        <lucide-icon name="Link" class="w-4 h-4"></lucide-icon>
      </button>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" [class.modal-open]="showHelpModal">
    <div class="modal-box max-w-3xl">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" (click)="showHelpModal = false">✕</button>
      
      <h3 class="font-bold text-lg mb-4">
        <lucide-icon name="Keyboard" class="w-5 h-5 inline-block mr-2"></lucide-icon>
        Editor Shortcuts & Help
      </h3>
      
      <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
        <!-- Text Formatting -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Text Formatting</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Bold</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + B</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Italic</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + I</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Underline</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + U</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Strikethrough</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + X</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Code</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + E</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Clear Formatting</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + \</kbd>
            </div>
          </div>
        </div>

        <!-- Lists -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Lists</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Bullet List</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + 8</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Numbered List</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + 9</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded col-span-2">
              <span>Create Bullet List</span>
              <span class="text-base-content/70">Type <kbd class="kbd kbd-xs">*</kbd> or <kbd class="kbd kbd-xs">-</kbd> at line start</span>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded col-span-2">
              <span>Create Numbered List</span>
              <span class="text-base-content/70">Type <kbd class="kbd kbd-xs">1.</kbd> at line start</span>
            </div>
          </div>
        </div>

        <!-- Blocks -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Blocks & Structure</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Heading 1</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Alt + 1</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Heading 2</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Alt + 2</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Heading 3</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Alt + 3</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Normal Text</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Alt + 0</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Quote</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + B</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Code Block</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Alt + C</kbd>
            </div>
          </div>
        </div>

        <!-- Editor Actions -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Editor Actions</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Save</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + S</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Undo</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Z</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Redo</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + Z</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Insert Link</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + K</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Insert Table</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + T</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Hard Break</span>
              <kbd class="kbd kbd-sm">Shift + Enter</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Insert Emoji</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + E</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Insert GIF</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Shift + G</kbd>
            </div>
          </div>
        </div>

        <!-- Table Shortcuts (when in table) -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Table Navigation</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Next Cell</span>
              <kbd class="kbd kbd-sm">Tab</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded">
              <span>Previous Cell</span>
              <kbd class="kbd kbd-sm">Shift + Tab</kbd>
            </div>
            <div class="flex justify-between p-2 bg-base-200 rounded col-span-2">
              <span>Exit Table</span>
              <kbd class="kbd kbd-sm">Ctrl/⌘ + Enter</kbd>
            </div>
          </div>
        </div>

        <!-- Quick Tips -->
        <div>
          <h4 class="font-semibold text-base mb-2 text-primary">Quick Tips</h4>
          <div class="space-y-2 text-sm">
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Drag and drop or paste images directly into the editor</span>
              </p>
            </div>
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Type <kbd class="kbd kbd-xs">```</kbd> at the start of a line for code blocks</span>
              </p>
            </div>
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Type <kbd class="kbd kbd-xs">&gt;</kbd> at the start of a line for quotes</span>
              </p>
            </div>
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Select text and click toolbar buttons to apply formatting</span>
              </p>
            </div>
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Auto-save is enabled - your work is saved automatically</span>
              </p>
            </div>
            <div class="p-3 bg-info/10 rounded-lg">
              <p class="flex items-start gap-2">
                <lucide-icon name="Lightbulb" class="w-4 h-4 text-info flex-shrink-0 mt-0.5"></lucide-icon>
                <span>Press <kbd class="kbd kbd-xs">F1</kbd> or <kbd class="kbd kbd-xs">Ctrl/⌘ + ?</kbd> to open this help again</span>
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-action">
        <button class="btn" (click)="showHelpModal = false">Close</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop" (click)="showHelpModal = false">
      <button>close</button>
    </form>
  </div>
</div> 